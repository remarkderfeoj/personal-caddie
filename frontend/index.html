<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1a1a2e">
    <title>Personal Caddie</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚õ≥</text></svg>">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root {
            --bg: #0f1923;
            --bg2: #1a2332;
            --card: #1e2d3d;
            --card-hover: #243447;
            --accent: #00d4aa;
            --accent2: #00b894;
            --text: #e8e8e8;
            --text2: #8899aa;
            --danger: #ff6b6b;
            --water: #4fc3f7;
            --sand: #ffcc02;
            --trees: #2d8a4e;
            --ob: #ff4757;
            --par3: #4fc3f7;
            --par4: #00d4aa;
            --par5: #ffd93d;
            --radius: 16px;
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }
        .app { max-width: 480px; margin: 0 auto; padding-bottom: 100px; }

        /* ‚îÄ‚îÄ NAV ‚îÄ‚îÄ */
        nav {
            position: sticky; top: 0; z-index: 100;
            background: rgba(15,25,35,.92);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 16px 20px;
            display: flex; align-items: center; justify-content: space-between;
            border-bottom: 1px solid rgba(255,255,255,.06);
        }
        .logo { font-size: 20px; font-weight: 700; display: flex; align-items: center; gap: 8px; }
        .logo span { color: var(--accent); }
        .nav-back { background:none; border:none; color:var(--accent); font-size:16px; cursor:pointer; display:none; padding:4px 8px; }

        /* ‚îÄ‚îÄ SCREENS ‚îÄ‚îÄ */
        .screen { display: none; padding: 20px; }
        .screen.active { display: block; }

        /* ‚îÄ‚îÄ FEATURED COURSES ‚îÄ‚îÄ */
        .section-title {
            font-size: 13px; font-weight: 600; text-transform: uppercase;
            letter-spacing: 2px; color: var(--text2); margin: 24px 0 12px; padding: 0 4px;
        }
        .search-box {
            width: 100%; padding: 14px 18px; padding-left: 44px;
            background: var(--card); border: 1px solid rgba(255,255,255,.08);
            border-radius: var(--radius); color: var(--text); font-size: 16px;
            outline: none; transition: all .2s;
        }
        .search-box:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(0,212,170,.15); }
        .search-wrap { position: relative; margin-bottom: 8px; }
        .search-icon {
            position: absolute; left: 16px; top: 50%; transform: translateY(-50%);
            color: var(--text2); font-size: 16px; pointer-events: none;
        }

        .course-grid { display: flex; flex-direction: column; gap: 12px; }
        .course-card {
            background: var(--card); border-radius: var(--radius);
            padding: 20px; cursor: pointer; transition: all .2s;
            border: 1px solid transparent; position: relative; overflow: hidden;
        }
        .course-card:active { transform: scale(.98); }
        .course-card:hover { border-color: rgba(0,212,170,.3); background: var(--card-hover); }
        .course-card-name { font-size: 17px; font-weight: 600; margin-bottom: 6px; }
        .course-card-meta { display: flex; gap: 16px; color: var(--text2); font-size: 13px; }
        .course-card-meta span { display: flex; align-items: center; gap: 4px; }
        .course-card-badge {
            position: absolute; top: 16px; right: 16px;
            background: rgba(0,212,170,.15); color: var(--accent);
            padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600;
        }
        .featured-badge { background: rgba(255,217,61,.15); color: #ffd93d; }

        /* ‚îÄ‚îÄ COURSE DETAIL / HOLE VIEW ‚îÄ‚îÄ */
        .course-header {
            background: linear-gradient(135deg, #1a3a2a 0%, #0f2b1f 100%);
            border-radius: var(--radius); padding: 24px; margin-bottom: 20px;
            border: 1px solid rgba(0,212,170,.15);
        }
        .course-header h2 { font-size: 22px; margin-bottom: 8px; }
        .course-header-stats { display: flex; gap: 20px; color: var(--text2); font-size: 13px; }

        .holes-grid { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px; }
        .hole-chip {
            width: 48px; height: 48px; border-radius: 12px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: var(--card); cursor: pointer; transition: all .2s;
            border: 2px solid transparent; font-size: 14px; font-weight: 600;
        }
        .hole-chip:active { transform: scale(.95); }
        .hole-chip.active { border-color: var(--accent); background: rgba(0,212,170,.1); }
        .hole-chip .par-dot {
            width: 6px; height: 6px; border-radius: 50%; margin-top: 3px;
        }
        .par3-dot { background: var(--par3); }
        .par4-dot { background: var(--par4); }
        .par5-dot { background: var(--par5); }

        /* ‚îÄ‚îÄ HOLE VISUALIZATION ‚îÄ‚îÄ */
        .hole-viz {
            background: var(--card); border-radius: var(--radius);
            padding: 20px; margin-bottom: 16px;
            border: 1px solid rgba(255,255,255,.06);
        }
        .hole-viz-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;
        }
        .hole-viz-header h3 { font-size: 18px; }
        .hole-viz-badges { display: flex; gap: 8px; }
        .badge {
            padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600;
        }
        .badge-par3 { background: rgba(79,195,247,.15); color: var(--par3); }
        .badge-par4 { background: rgba(0,212,170,.15); color: var(--par4); }
        .badge-par5 { background: rgba(255,217,61,.15); color: var(--par5); }

        .hole-svg-container {
            width: 100%; aspect-ratio: 1/1.8; background: #0a1510;
            border-radius: 12px; overflow: hidden; margin-bottom: 12px;
            position: relative; cursor: crosshair;
        }
        .hole-svg-container svg { width: 100%; height: 100%; }
        .tap-hint {
            font-size: 11px; color: var(--text2); text-align: center;
            margin-top: -8px; margin-bottom: 12px; opacity: .6;
        }

        /* View toggle */
        .view-toggle {
            display: flex; gap: 4px; background: var(--bg);
            border-radius: 10px; padding: 3px; margin-bottom: 12px;
        }
        .view-toggle button {
            flex: 1; padding: 8px; border: none; border-radius: 8px;
            background: transparent; color: var(--text2); font-size: 12px;
            font-weight: 600; cursor: pointer; transition: all .2s;
        }
        .view-toggle button.active {
            background: var(--accent); color: #000;
        }

        /* Satellite map */
        .satellite-map {
            width: 100%; height: 500px; border-radius: 12px;
            overflow: hidden; margin-bottom: 12px; position: relative;
        }
        
        /* Map overlay controls */
        .map-controls {
            position: absolute; top: 12px; left: 12px; right: 12px;
            display: flex; justify-content: space-between; align-items: flex-start;
            z-index: 1000; pointer-events: none;
        }
        .map-controls > * { pointer-events: auto; }
        
        .map-hole-badge {
            background: rgba(0,0,0,.85); backdrop-filter: blur(10px);
            padding: 10px 16px; border-radius: 12px;
            display: flex; flex-direction: column; gap: 2px;
            border: 1px solid rgba(255,255,255,.1);
        }
        .map-hole-badge .hole-num {
            font-size: 18px; font-weight: 700; color: var(--accent);
        }
        .map-hole-badge .hole-par {
            font-size: 11px; color: var(--text2); text-transform: uppercase;
        }
        
        .map-nav-arrows {
            display: flex; gap: 8px;
        }
        .map-nav-btn {
            width: 40px; height: 40px; border-radius: 10px;
            background: rgba(0,0,0,.85); backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,.1); color: var(--text);
            font-size: 18px; cursor: pointer; transition: all .2s;
            display: flex; align-items: center; justify-content: center;
        }
        .map-nav-btn:active { transform: scale(.95); background: rgba(0,212,170,.2); }
        .map-nav-btn:disabled { opacity: .3; cursor: not-allowed; }
        
        .map-gps-btn {
            position: absolute; bottom: 80px; right: 12px; z-index: 1000;
            width: 48px; height: 48px; border-radius: 50%;
            background: var(--accent); color: #000; border: none;
            font-size: 20px; cursor: pointer; transition: all .2s;
            box-shadow: 0 4px 12px rgba(0,212,170,.4);
        }
        .map-gps-btn:active { transform: scale(.95); }
        
        .map-distance-label {
            position: absolute; bottom: 20px; left: 50%;
            transform: translateX(-50%); z-index: 1000;
            background: rgba(0,0,0,.9); backdrop-filter: blur(10px);
            padding: 12px 24px; border-radius: 20px;
            font-size: 16px; font-weight: 700; color: var(--accent);
            border: 1px solid rgba(0,212,170,.3);
            display: none;
        }
        .map-distance-label.visible { display: block; }

        /* Leaflet custom marker styles */
        .leaflet-marker-icon.ball-marker {
            background: var(--accent);
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0,0,0,.4);
        }

        /* Map unavailable notice */
        .map-unavailable {
            padding: 12px; background: rgba(255,217,61,.1);
            border: 1px solid rgba(255,217,61,.2); border-radius: 10px;
            text-align: center; font-size: 12px; color: #ffd93d;
            margin-bottom: 12px;
        }

        /* Recommendation card below map */
        .map-rec-card {
            background: linear-gradient(135deg, #0a2a1a 0%, #1a3a2a 100%);
            border-radius: var(--radius); padding: 16px;
            border: 1px solid rgba(0,212,170,.2); margin-top: 12px;
            display: none;
        }
        .map-rec-card.visible { display: block; }
        .map-rec-card .rec-club-name {
            font-size: 24px; font-weight: 700; color: var(--accent);
            margin-bottom: 4px;
        }
        .map-rec-card .rec-distance {
            font-size: 14px; color: var(--text2); margin-bottom: 8px;
        }
        .map-rec-card .rec-confidence {
            font-size: 12px; color: var(--accent);
        }
        .map-rec-card .rec-expand {
            margin-top: 12px; padding: 8px; text-align: center;
            background: rgba(0,212,170,.1); border-radius: 8px;
            font-size: 11px; color: var(--accent); cursor: pointer;
        }

        /* Wind compass */
        .wind-compass {
            display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px;
        }
        .wind-btn {
            padding: 10px 4px; border-radius: 8px;
            background: var(--bg); border: 1px solid rgba(255,255,255,.1);
            color: var(--text2); font-size: 11px; text-align: center;
            cursor: pointer; transition: all .2s;
        }
        .wind-btn.active { border-color: var(--accent); color: var(--accent); background: rgba(0,212,170,.08); }
        .wind-btn:active { transform: scale(.95); }

        .hole-info-row {
            display: flex; justify-content: space-between; padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,.06); font-size: 14px;
        }
        .hole-info-row:last-child { border-bottom: none; }
        .hole-info-label { color: var(--text2); }
        .hole-info-value { font-weight: 600; }

        .hazard-list { margin-top: 12px; }
        .hazard-chip {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 6px 12px; border-radius: 20px; font-size: 12px;
            margin: 4px 4px 4px 0;
        }
        .hazard-water { background: rgba(79,195,247,.15); color: var(--water); }
        .hazard-bunker { background: rgba(255,204,2,.15); color: var(--sand); }
        .hazard-ob { background: rgba(255,71,87,.15); color: var(--ob); }
        .hazard-trees { background: rgba(45,138,78,.15); color: var(--trees); }

        /* ‚îÄ‚îÄ SHOT FORM ‚îÄ‚îÄ */
        .shot-form {
            background: var(--card); border-radius: var(--radius);
            padding: 24px; border: 1px solid rgba(255,255,255,.06);
        }
        .shot-form h3 { font-size: 16px; margin-bottom: 20px; color: var(--accent); }
        .form-row { display: flex; gap: 12px; margin-bottom: 16px; }
        .form-group { flex: 1; }
        .form-group label {
            display: block; font-size: 11px; font-weight: 600;
            text-transform: uppercase; letter-spacing: 1px;
            color: var(--text2); margin-bottom: 6px;
        }
        .form-group input, .form-group select {
            width: 100%; padding: 12px 14px;
            background: var(--bg); border: 1px solid rgba(255,255,255,.1);
            border-radius: 10px; color: var(--text); font-size: 15px;
        }
        .form-group input:focus, .form-group select:focus {
            outline: none; border-color: var(--accent);
        }
        .form-group select { appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath d='M2 4l4 4 4-4' fill='none' stroke='%238899aa' stroke-width='1.5'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; padding-right: 32px; }

        .btn-recommend {
            width: 100%; padding: 16px; margin-top: 8px;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent2) 100%);
            color: #000; border: none; border-radius: 12px;
            font-size: 16px; font-weight: 700; cursor: pointer;
            text-transform: uppercase; letter-spacing: 1px;
            transition: all .2s; box-shadow: 0 4px 20px rgba(0,212,170,.3);
        }
        .btn-recommend:active { transform: scale(.98); opacity: .9; }
        .btn-recommend:disabled { opacity: .4; cursor: not-allowed; }

        /* ‚îÄ‚îÄ RECOMMENDATION RESULT ‚îÄ‚îÄ */
        .rec-card {
            background: linear-gradient(135deg, #0a2a1a 0%, #1a3a2a 100%);
            border-radius: var(--radius); padding: 24px;
            border: 1px solid rgba(0,212,170,.2); margin-top: 16px;
        }
        .rec-club { font-size: 36px; font-weight: 800; text-align: center; color: var(--accent); margin-bottom: 4px; }
        .rec-call { text-align: center; font-size: 16px; color: var(--text2); margin-bottom: 20px; font-style: italic; }
        .rec-stats { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        .rec-stat { text-align: center; }
        .rec-stat-val { font-size: 22px; font-weight: 700; color: var(--accent); }
        .rec-stat-label { font-size: 11px; color: var(--text2); text-transform: uppercase; letter-spacing: .5px; margin-top: 2px; }
        .rec-detail {
            background: rgba(0,0,0,.2); border-radius: 12px; padding: 16px; margin-bottom: 12px;
        }
        .rec-detail h4 { font-size: 12px; text-transform: uppercase; letter-spacing: 1px; color: var(--accent); margin-bottom: 8px; }
        .rec-detail p { font-size: 14px; line-height: 1.5; color: var(--text2); }
        .rec-risk {
            display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px;
        }
        .rec-risk-item { font-size: 12px; padding: 10px; border-radius: 10px; }
        .risk-agg { background: rgba(255,217,61,.08); border: 1px solid rgba(255,217,61,.15); }
        .risk-con { background: rgba(79,195,247,.08); border: 1px solid rgba(79,195,247,.15); }
        .risk-label { font-weight: 600; margin-bottom: 4px; }
        .risk-agg .risk-label { color: #ffd93d; }
        .risk-con .risk-label { color: #4fc3f7; }

        .rec-alts { margin-top: 16px; }
        .rec-alt {
            display: flex; align-items: center; gap: 12px;
            background: rgba(0,0,0,.2); border-radius: 10px; padding: 12px; margin-top: 8px;
        }
        .rec-alt-club { font-weight: 700; color: var(--text); min-width: 80px; }
        .rec-alt-scenario { font-size: 12px; color: var(--text2); }

        .caddie-note {
            text-align: center; padding: 16px; margin-top: 12px;
            font-style: italic; color: var(--text2); font-size: 14px;
            border-top: 1px solid rgba(255,255,255,.06);
        }

        /* ‚îÄ‚îÄ ERROR ‚îÄ‚îÄ */
        .error-msg {
            background: rgba(255,107,107,.1); border: 1px solid rgba(255,107,107,.2);
            border-radius: 12px; padding: 16px; color: var(--danger);
            text-align: center; font-size: 14px; margin-top: 16px;
        }

        /* ‚îÄ‚îÄ LOADING ‚îÄ‚îÄ */
        .loading { text-align: center; padding: 40px; color: var(--text2); }
        .spinner {
            width: 40px; height: 40px; border: 3px solid var(--card);
            border-top-color: var(--accent); border-radius: 50%;
            animation: spin 1s linear infinite; margin: 0 auto 12px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ‚îÄ‚îÄ BOTTOM NAV ‚îÄ‚îÄ */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(15,25,35,.95); backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            display: flex; justify-content: center; gap: 40px;
            padding: 12px 20px; padding-bottom: max(12px, env(safe-area-inset-bottom));
            border-top: 1px solid rgba(255,255,255,.06);
            z-index: 100;
        }
        .bottom-nav button {
            background: none; border: none; color: var(--text2);
            font-size: 11px; cursor: pointer; display: flex;
            flex-direction: column; align-items: center; gap: 4px;
            transition: color .2s;
        }
        .bottom-nav button.active { color: var(--accent); }
        .bottom-nav button .icon { font-size: 22px; }

        /* ‚îÄ‚îÄ MY BAG / ONBOARDING ‚îÄ‚îÄ */
        .bag-header {
            text-align: center; padding: 20px 0 10px;
        }
        .bag-header h2 { font-size: 22px; margin-bottom: 4px; }
        .bag-header p { color: var(--text2); font-size: 14px; }
        .bag-name-input {
            width: 100%; padding: 14px 18px; background: var(--card);
            border: 1px solid rgba(255,255,255,.08); border-radius: var(--radius);
            color: var(--text); font-size: 16px; outline: none; margin-bottom: 16px;
        }
        .bag-name-input:focus { border-color: var(--accent); }
        .bag-section { margin-bottom: 20px; }
        .bag-section-title {
            font-size: 12px; font-weight: 600; text-transform: uppercase;
            letter-spacing: 1.5px; color: var(--text2); margin-bottom: 10px;
        }
        .club-row {
            display: flex; align-items: center; gap: 12px;
            background: var(--card); border-radius: 12px; padding: 12px 16px;
            margin-bottom: 8px; border: 1px solid transparent;
            transition: all .2s;
        }
        .club-row.in-bag { border-color: rgba(0,212,170,.2); background: var(--card-hover); }
        .club-toggle {
            width: 36px; height: 36px; border-radius: 50%;
            border: 2px solid rgba(255,255,255,.15); background: transparent;
            color: var(--text2); font-size: 16px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: all .2s; flex-shrink: 0;
        }
        .club-toggle.active {
            border-color: var(--accent); background: rgba(0,212,170,.15); color: var(--accent);
        }
        .club-name { flex: 1; font-size: 15px; font-weight: 500; }
        .club-distance-inputs { display: flex; gap: 8px; align-items: center; }
        .club-dist-input {
            width: 60px; padding: 8px; text-align: center;
            background: var(--bg); border: 1px solid rgba(255,255,255,.1);
            border-radius: 8px; color: var(--text); font-size: 14px; font-weight: 600;
        }
        .club-dist-input:focus { outline: none; border-color: var(--accent); }
        .club-dist-label { font-size: 10px; color: var(--text2); text-align: center; }
        .club-dist-group { display: flex; flex-direction: column; align-items: center; gap: 2px; }
        .bag-save-btn {
            width: 100%; padding: 16px; margin-top: 16px;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent2) 100%);
            color: #000; border: none; border-radius: 12px;
            font-size: 16px; font-weight: 700; cursor: pointer;
            text-transform: uppercase; letter-spacing: 1px;
            transition: all .2s; box-shadow: 0 4px 20px rgba(0,212,170,.3);
        }
        .bag-save-btn:active { transform: scale(.98); opacity: .9; }
        .bag-save-btn:disabled { opacity: .4; cursor: not-allowed; }
        .bag-status {
            text-align: center; margin-top: 12px; font-size: 14px;
            padding: 12px; border-radius: 10px;
        }
        .bag-status.success { background: rgba(0,212,170,.1); color: var(--accent); }
        .bag-status.error { background: rgba(255,107,107,.1); color: var(--danger); }
        .bag-preset-row { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }
        .bag-preset-btn {
            padding: 8px 16px; border-radius: 20px; border: 1px solid rgba(255,255,255,.15);
            background: transparent; color: var(--text2); font-size: 13px;
            cursor: pointer; transition: all .2s;
        }
        .bag-preset-btn:hover { border-color: var(--accent); color: var(--accent); }
        .bag-preset-btn.active { border-color: var(--accent); background: rgba(0,212,170,.1); color: var(--accent); }
        .bag-general {
            background: var(--card); border-radius: 12px; padding: 16px;
            margin-bottom: 16px;
        }
        .bag-general .form-row { margin-bottom: 12px; }
        .bag-general .form-row:last-child { margin-bottom: 0; }
        .bag-count {
            font-size: 13px; color: var(--text2); text-align: right; margin-bottom: 8px;
        }
        .bag-count span { color: var(--accent); font-weight: 600; }
    </style>
</head>
<body>
<div class="app">
    <nav>
        <button class="nav-back" id="navBack" onclick="goBack()">‚Üê Back</button>
        <div class="logo">‚õ≥ <span>Personal Caddie</span></div>
        <div style="width:60px"></div>
    </nav>

    <!-- SCREEN: HOME / FEATURED COURSES -->
    <div class="screen active" id="screenHome">
        <div class="search-wrap">
            <span class="search-icon">üîç</span>
            <input class="search-box" id="courseSearch" placeholder="Search courses..." autocomplete="off">
        </div>
        <div class="section-title">Featured Courses</div>
        <div class="course-grid" id="courseGrid">
            <div class="loading"><div class="spinner"></div>Loading courses...</div>
        </div>
    </div>

    <!-- SCREEN: COURSE DETAIL -->
    <div class="screen" id="screenCourse">
        <div class="course-header" id="courseHeader"></div>
        <div class="section-title">Select a Hole</div>
        <div class="holes-grid" id="holesGrid"></div>
        <div id="holeDetail"></div>
    </div>

    <!-- SCREEN: SHOT ADVISOR -->
    <div class="screen" id="screenShot">
        <div id="shotHoleViz"></div>
        <div class="shot-form">
            <h3>üéØ Shot Advisor</h3>
            <div class="form-row">
                <div class="form-group">
                    <label>Distance (yds)</label>
                    <input type="number" id="fDistance" value="150" min="1">
                </div>
                <div class="form-group">
                    <label>Lie</label>
                    <select id="fLie">
                        <option value="tee">Tee</option>
                        <option value="fairway" selected>Fairway</option>
                        <option value="rough">Rough</option>
                        <option value="sand">Bunker</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label>Wind Speed (mph)</label>
                <input type="range" id="fWind" min="0" max="35" value="0" style="width:100%;accent-color:var(--accent)" oninput="document.getElementById('windVal').textContent=this.value+' mph'">
                <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--text2);margin-top:4px"><span>Calm</span><span id="windVal">0 mph</span><span>35+</span></div>
            </div>
            <div class="form-group" style="margin-top:8px">
                <label>Wind Direction (relative to shot)</label>
                <div class="wind-compass">
                    <div class="wind-btn active" data-wind="calm" onclick="setWind(this)">üçÉ<br>Calm</div>
                    <div class="wind-btn" data-wind="headwind" onclick="setWind(this)">‚¨áÔ∏è<br>Into</div>
                    <div class="wind-btn" data-wind="tailwind" onclick="setWind(this)">‚¨ÜÔ∏è<br>Helping</div>
                    <div class="wind-btn" data-wind="left-to-right" onclick="setWind(this)">‚û°Ô∏è<br>L‚ÜíR</div>
                    <div class="wind-btn" data-wind="right-to-left" onclick="setWind(this)">‚¨ÖÔ∏è<br>R‚ÜíL</div>
                </div>
                <input type="hidden" id="fWindDir" value="calm">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Elevation Œî (ft)</label>
                    <input type="number" id="fElev" value="0" step="5">
                </div>
                <div class="form-group" style="display:flex;align-items:flex-end;">
                    <button class="btn-recommend" id="btnRecommend" onclick="getRecommendation()">
                        Get Club
                    </button>
                </div>
            </div>
        </div>
        <div id="recResult"></div>
    </div>

    <!-- SCREEN: MY BAG -->
    <div class="screen" id="screenBag">
        <div class="bag-header">
            <h2>üèåÔ∏è My Bag</h2>
            <p>Set up your clubs so your caddie knows your game</p>
        </div>

        <input class="bag-name-input" id="bagPlayerName" placeholder="Your name" autocomplete="name">

        <div class="section-title">Quick Setup</div>
        <div class="bag-preset-row">
            <button class="bag-preset-btn" onclick="applyPreset('beginner')">üü¢ Beginner</button>
            <button class="bag-preset-btn" onclick="applyPreset('average')">üîµ Average</button>
            <button class="bag-preset-btn" onclick="applyPreset('advanced')">üü° Advanced</button>
            <button class="bag-preset-btn" onclick="applyPreset('scratch')">üî¥ Scratch</button>
        </div>

        <div class="bag-count">Clubs in bag: <span id="bagClubCount">0</span> / 14</div>

        <div id="bagClubList"></div>

        <div class="section-title">General</div>
        <div class="bag-general">
            <div class="form-row">
                <div class="form-group">
                    <label>Miss Tendency</label>
                    <select id="bagMiss">
                        <option value="">Not sure</option>
                        <option value="push">Push / Fade</option>
                        <option value="pull">Pull / Draw</option>
                        <option value="slice">Slice</option>
                        <option value="hook">Hook</option>
                        <option value="thin">Thin</option>
                        <option value="fat">Fat</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Short Game</label>
                    <select id="bagShortGame">
                        <option value="">Average</option>
                        <option value="strong">Strong</option>
                        <option value="weak">Weak</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Measurement</label>
                    <select id="bagMeasure">
                        <option value="estimated">Estimated</option>
                        <option value="gps_watch">GPS Watch</option>
                        <option value="rangefinder">Rangefinder</option>
                        <option value="course_markers">Course Markers</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Swing Speed</label>
                    <select id="bagSpeed">
                        <option value="">Don't know</option>
                        <option value="70">~70 mph (Slow)</option>
                        <option value="85">~85 mph (Average)</option>
                        <option value="95">~95 mph (Fast)</option>
                        <option value="105">~105 mph (Tour)</option>
                    </select>
                </div>
            </div>
        </div>

        <button class="bag-save-btn" id="bagSaveBtn" onclick="saveBag()">üíæ Save My Bag</button>
        <div id="bagStatus"></div>
    </div>

    <div class="bottom-nav">
        <button class="active" onclick="showScreen('home')"><span class="icon">üè†</span>Courses</button>
        <button onclick="showScreen('shot')"><span class="icon">üéØ</span>Advisor</button>
        <button onclick="showScreen('bag')"><span class="icon">üéí</span>My Bag</button>
    </div>
</div>

<script>
const API = window.location.origin;
let allCourses = [];
let currentCourse = null;
let currentHoles = [];
let selectedHole = null;
let navStack = ['home'];
let currentCourseData = null;
let satMapInstance = null;
let ballMarker = null;
let pinMarker = null;
let teeMarker = null;
let greenMarker = null;
let distanceLine = null;
let teeGreenLine = null;
let ballPosition = null;
let gpsCircle = null;
let recDebounceTimer = null;

// ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ
function showScreen(name) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById('screen' + name.charAt(0).toUpperCase() + name.slice(1)).classList.add('active');
    document.querySelectorAll('.bottom-nav button').forEach(b => b.classList.remove('active'));
    if (name === 'home') document.querySelectorAll('.bottom-nav button')[0].classList.add('active');
    if (name === 'shot') document.querySelectorAll('.bottom-nav button')[1].classList.add('active');
    if (name === 'bag') document.querySelectorAll('.bottom-nav button')[2].classList.add('active');
    document.getElementById('navBack').style.display = (name === 'home') ? 'none' : 'block';
    if (name !== navStack[navStack.length - 1]) navStack.push(name);
}

function goBack() {
    navStack.pop();
    const prev = navStack[navStack.length - 1] || 'home';
    showScreen(prev);
}

// ‚îÄ‚îÄ HAVERSINE DISTANCE ‚îÄ‚îÄ
function haversineDistance(lat1, lon1, lat2, lon2) {
    const R = 3958.8; // Earth radius in miles
    const toRad = (deg) => deg * Math.PI / 180;
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a = Math.sin(dLat / 2) ** 2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon / 2) ** 2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c * 1760; // Convert miles to yards
}

// ‚îÄ‚îÄ LOAD COURSES ‚îÄ‚îÄ
async function loadCourses() {
    try {
        const res = await fetch(`${API}/api/v1/courses`);
        const data = await res.json();
        allCourses = data.courses || [];
        renderCourseGrid(allCourses);
    } catch (e) {
        document.getElementById('courseGrid').innerHTML = '<div class="error-msg">Could not load courses</div>';
    }
}

function renderCourseGrid(courses) {
    const grid = document.getElementById('courseGrid');
    if (!courses.length) { grid.innerHTML = '<div style="color:var(--text2);text-align:center;padding:20px">No courses found</div>'; return; }

    const featured = ['augusta_national', 'tpc_sawgrass', 'st_andrews_old', 'pebble_beach', 'pine_valley'];
    const local = ['rocky_river', 'eagle_chase', 'sunset_hills', 'warrior_gc', 'skybrook'];
    
    // Sort: local first, then featured, then rest
    const sorted = [...courses].sort((a, b) => {
        const aLocal = local.includes(a.id) ? 0 : 1;
        const bLocal = local.includes(b.id) ? 0 : 1;
        if (aLocal !== bLocal) return aLocal - bLocal;
        const aFeat = featured.includes(a.id) ? 0 : 1;
        const bFeat = featured.includes(b.id) ? 0 : 1;
        return aFeat - bFeat;
    });

    grid.innerHTML = sorted.map(c => {
        const isFeatured = featured.includes(c.id);
        const isLocal = local.includes(c.id);
        let badge = '';
        if (isLocal) badge = '<span class="course-card-badge" style="background:rgba(79,195,247,.15);color:#4fc3f7">üìç Charlotte Area</span>';
        else if (isFeatured) badge = '<span class="course-card-badge featured-badge">‚≠ê Featured</span>';
        return `<div class="course-card" onclick="openCourse('${c.id}')">
            ${badge}
            <div class="course-card-name">${c.name}</div>
            <div class="course-card-meta">
                <span>‚õ≥ ${c.holes} holes</span>
                <span>üìç ${c.elevation_feet} ft</span>
            </div>
        </div>`;
    }).join('');
}

// ‚îÄ‚îÄ SEARCH ‚îÄ‚îÄ
document.getElementById('courseSearch').addEventListener('input', (e) => {
    const q = e.target.value.trim().toLowerCase();
    if (!q) { renderCourseGrid(allCourses); return; }
    renderCourseGrid(allCourses.filter(c => c.name.toLowerCase().includes(q)));
});

// ‚îÄ‚îÄ COURSE DETAIL ‚îÄ‚îÄ
async function openCourse(courseId) {
    showScreen('course');
    currentCourse = allCourses.find(c => c.id === courseId);

    document.getElementById('courseHeader').innerHTML = `
        <h2>${currentCourse.name}</h2>
        <div class="course-header-stats">
            <span>‚õ≥ ${currentCourse.holes} holes</span>
            <span>üìç ${currentCourse.elevation_feet} ft elevation</span>
        </div>
    `;

    // Load holes
    try {
        const res = await fetch(`${API}/api/v1/courses/${courseId}/holes`);
        const data = await res.json();
        currentHoles = data.holes || [];
        currentCourseData = data;
        renderHoleChips();
        if (currentHoles.length > 0) selectHole(currentHoles[0]);
    } catch (e) {
        document.getElementById('holesGrid').innerHTML = '<div class="error-msg">Could not load holes</div>';
    }
}

function renderHoleChips() {
    document.getElementById('holesGrid').innerHTML = currentHoles.map(h => {
        const parClass = h.par === 3 ? 'par3' : h.par === 5 ? 'par5' : 'par4';
        return `<div class="hole-chip" id="chip${h.hole_number}" onclick="selectHole(currentHoles.find(x=>x.hole_number===${h.hole_number}))">
            ${h.hole_number}
            <div class="par-dot ${parClass}-dot"></div>
        </div>`;
    }).join('');
}

function selectHole(hole) {
    selectedHole = hole;
    ballPosition = null;
    document.querySelectorAll('.hole-chip').forEach(c => c.classList.remove('active'));
    const chip = document.getElementById('chip' + hole.hole_number);
    if (chip) chip.classList.add('active');
    renderHoleDetail(hole);
}

function renderHoleDetail(hole) {
    const parClass = hole.par === 3 ? 'par3' : hole.par === 5 ? 'par5' : 'par4';
    const parBadge = `badge-${parClass}`;
    const hazardChips = (hole.hazards || []).map(h => {
        const cls = h.type === 'water' ? 'hazard-water' : h.type === 'bunker' ? 'hazard-bunker' : h.type === 'out_of_bounds' ? 'hazard-ob' : 'hazard-trees';
        const icon = h.type === 'water' ? 'üíß' : h.type === 'bunker' ? '‚è≥' : h.type === 'out_of_bounds' ? 'üö´' : 'üå≤';
        return `<span class="hazard-chip ${cls}">${icon} ${h.description || h.type} (${h.location})</span>`;
    }).join('');

    const hasCoords = hole.tee_lat && hole.tee_lng && hole.green_lat && hole.green_lng;

    document.getElementById('holeDetail').innerHTML = `
        <div class="hole-viz">
            <div class="hole-viz-header">
                <h3>Hole ${hole.hole_number}</h3>
                <div class="hole-viz-badges">
                    <span class="badge ${parBadge}">Par ${hole.par}</span>
                    <span class="badge" style="background:rgba(255,255,255,.06);color:var(--text2)">${hole.distance} yds</span>
                </div>
            </div>
            ${hasCoords ? `
                <div class="view-toggle">
                    <button class="active" id="viewToggleSat" onclick="switchView('satellite', ${hole.hole_number})">üõ∞Ô∏è Satellite</button>
                    <button id="viewToggleDiag" onclick="switchView('diagram', ${hole.hole_number})">üìê Diagram</button>
                </div>
                <div id="satelliteView">
                    <div class="satellite-map" id="satMap"></div>
                </div>
                <div id="diagramView" style="display:none">
                    <div class="hole-svg-container" onclick="handleHoleTap(event, ${hole.hole_number})" id="holeVizSvg">${generateHoleSVG(hole)}</div>
                    <div class="tap-hint">üëÜ Tap the hole to set your position and get distance to pin</div>
                </div>
            ` : `
                <div class="map-unavailable">üìç Satellite view unavailable for this hole ‚Ä¢ Using diagram</div>
                <div id="diagramView">
                    <div class="hole-svg-container" onclick="handleHoleTap(event, ${hole.hole_number})" id="holeVizSvg">${generateHoleSVG(hole)}</div>
                    <div class="tap-hint">üëÜ Tap the hole to set your position and get distance to pin</div>
                </div>
            `}
            <div class="hole-info-row"><span class="hole-info-label">Distance</span><span class="hole-info-value">${hole.distance} yards</span></div>
            <div class="hole-info-row"><span class="hole-info-label">Par</span><span class="hole-info-value">${hole.par}</span></div>
            <div class="hole-info-row"><span class="hole-info-label">Handicap</span><span class="hole-info-value">${hole.handicap_index}</span></div>
            <div class="hole-info-row"><span class="hole-info-label">Elevation</span><span class="hole-info-value">${hole.elevation_change > 0 ? '+' : ''}${hole.elevation_change} ft</span></div>
            <div class="hole-info-row"><span class="hole-info-label">Green</span><span class="hole-info-value">${(hole.green_shape || 'medium').replace('_',' ')}</span></div>
            ${hazardChips ? `<div class="hazard-list">${hazardChips}</div>` : ''}
            ${hole.notes ? `<div style="margin-top:12px;font-size:13px;color:var(--text2);font-style:italic">üìù ${hole.notes}</div>` : ''}
        </div>
        <button class="btn-recommend" onclick="startShot()" style="margin-top:0">üéØ Get Club Recommendation</button>
    `;

    // Initialize satellite map if has coords
    if (hasCoords) {
        setTimeout(() => initSatelliteMap(hole), 100);
    }
}

// ‚îÄ‚îÄ SATELLITE MAP WITH LEAFLET ‚îÄ‚îÄ
function initSatelliteMap(hole) {
    if (!hole.tee_lat || !hole.green_lat) return;

    const mapDiv = document.getElementById('satMap');
    if (!mapDiv) return;

    // Clean up existing map
    if (satMapInstance) {
        satMapInstance.remove();
        satMapInstance = null;
    }

    // Create map centered on green
    satMapInstance = L.map(mapDiv, {
        zoomControl: false,
        attributionControl: false,
    });

    // Add ESRI World Imagery satellite tiles (free, no API key needed)
    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        maxZoom: 20,
        attribution: 'ESRI',
    }).addTo(satMapInstance);

    // Add zoom control in bottom left
    L.control.zoom({ position: 'bottomleft' }).addTo(satMapInstance);

    // Tee marker (yellow square)
    teeMarker = L.marker([hole.tee_lat, hole.tee_lng], {
        icon: L.divIcon({
            className: 'custom-marker',
            html: '<div style="width:16px;height:16px;background:#ffd93d;border:2px solid white;transform:translate(-8px,-8px);"></div>',
            iconSize: [0, 0],
        }),
    }).addTo(satMapInstance);

    // Green marker (green circle)
    greenMarker = L.circle([hole.green_lat, hole.green_lng], {
        color: '#00d4aa',
        fillColor: '#2d8a4e',
        fillOpacity: 0.5,
        radius: 10,
    }).addTo(satMapInstance);

    // Pin marker (flag)
    pinMarker = L.marker([hole.green_lat, hole.green_lng], {
        icon: L.divIcon({
            className: 'custom-marker',
            html: '<div style="font-size:24px;transform:translate(-12px,-24px);">‚õ≥</div>',
            iconSize: [0, 0],
        }),
    }).addTo(satMapInstance);

    // Tee to green reference line
    teeGreenLine = L.polyline(
        [[hole.tee_lat, hole.tee_lng], [hole.green_lat, hole.green_lng]],
        {
            color: '#8899aa',
            weight: 2,
            opacity: 0.4,
            dashArray: '8, 8',
        }
    ).addTo(satMapInstance);

    // Ball marker (draggable)
    ballMarker = L.marker([hole.tee_lat, hole.tee_lng], {
        icon: L.divIcon({
            className: 'custom-marker',
            html: '<div style="width:20px;height:20px;background:var(--accent);border:3px solid white;border-radius:50%;box-shadow:0 2px 8px rgba(0,0,0,.5);transform:translate(-10px,-10px);"></div>',
            iconSize: [0, 0],
        }),
        draggable: true,
    }).addTo(satMapInstance);

    // Ball marker drag handlers
    ballMarker.on('drag', () => {
        const pos = ballMarker.getLatLng();
        ballPosition = pos;
        updateMapDistance(hole);
    });

    ballMarker.on('dragend', () => {
        const pos = ballMarker.getLatLng();
        ballPosition = pos;
        updateMapDistance(hole);
        updateShotForm(hole);
        // Debounced recommendation update
        clearTimeout(recDebounceTimer);
        recDebounceTimer = setTimeout(() => {
            fetchQuickRecommendation(hole);
        }, 300);
    });

    // Fit bounds to show tee and green with appropriate padding
    const bounds = L.latLngBounds([
        [hole.tee_lat, hole.tee_lng],
        [hole.green_lat, hole.green_lng],
    ]);
    satMapInstance.fitBounds(bounds, { padding: [60, 40] });

    // Add map overlay controls
    addMapControls(hole);
}

function addMapControls(hole) {
    const mapDiv = document.getElementById('satMap');
    if (!mapDiv) return;

    // Remove existing controls
    const existing = mapDiv.querySelector('.map-controls');
    if (existing) existing.remove();

    const controls = document.createElement('div');
    controls.className = 'map-controls';
    controls.innerHTML = `
        <div class="map-hole-badge">
            <div class="hole-num">#${hole.hole_number}</div>
            <div class="hole-par">Par ${hole.par} ‚Ä¢ ${hole.distance}yd</div>
        </div>
        <div class="map-nav-arrows">
            <button class="map-nav-btn" id="prevHoleBtn" onclick="navigateToPrevHole()">‚óÄ</button>
            <button class="map-nav-btn" id="nextHoleBtn" onclick="navigateToNextHole()">‚ñ∂</button>
        </div>
    `;
    mapDiv.appendChild(controls);

    // Add GPS button
    const gpsBtn = document.createElement('button');
    gpsBtn.className = 'map-gps-btn';
    gpsBtn.innerHTML = 'üìç';
    gpsBtn.title = 'Use My GPS';
    gpsBtn.onclick = () => useMyGPS(hole);
    mapDiv.appendChild(gpsBtn);

    // Add distance label
    const distLabel = document.createElement('div');
    distLabel.className = 'map-distance-label';
    distLabel.id = 'mapDistLabel';
    mapDiv.appendChild(distLabel);

    // Disable prev/next buttons if at edges
    const holeIndex = currentHoles.findIndex(h => h.hole_number === hole.hole_number);
    if (holeIndex === 0) document.getElementById('prevHoleBtn').disabled = true;
    if (holeIndex === currentHoles.length - 1) document.getElementById('nextHoleBtn').disabled = true;
}

function updateMapDistance(hole) {
    if (!ballPosition || !satMapInstance) return;
    
    const dist = Math.round(haversineDistance(
        ballPosition.lat, ballPosition.lng,
        hole.green_lat, hole.green_lng
    ));

    // Update distance label
    const label = document.getElementById('mapDistLabel');
    if (label) {
        label.textContent = `${dist} yds to pin`;
        label.classList.add('visible');
    }

    // Update line from ball to pin
    if (distanceLine) {
        satMapInstance.removeLayer(distanceLine);
    }
    distanceLine = L.polyline(
        [[ballPosition.lat, ballPosition.lng], [hole.green_lat, hole.green_lng]],
        {
            color: '#00d4aa',
            weight: 3,
            opacity: 0.8,
            dashArray: '10, 10',
        }
    ).addTo(satMapInstance);
}

function updateShotForm(hole) {
    if (!ballPosition) return;
    
    const dist = Math.round(haversineDistance(
        ballPosition.lat, ballPosition.lng,
        hole.green_lat, hole.green_lng
    ));

    // Estimate lie based on distance from tee-green line
    // Simple approach: calculate perpendicular distance from ball to tee-green line
    const teeLat = hole.tee_lat;
    const teeLng = hole.tee_lng;
    const greenLat = hole.green_lat;
    const greenLng = hole.green_lng;
    
    // Calculate if ball is far from center line (rough estimate)
    const centerLat = (teeLat + greenLat) / 2;
    const centerLng = (teeLng + greenLng) / 2;
    const distFromCenter = haversineDistance(ballPosition.lat, ballPosition.lng, centerLat, centerLng);
    const fairwayWidth = 30; // yards, rough estimate
    
    let lie = 'fairway';
    if (distFromCenter > fairwayWidth) {
        lie = 'rough';
    }
    
    // Check if on tee (within 10 yards of tee)
    const distFromTee = haversineDistance(ballPosition.lat, ballPosition.lng, teeLat, teeLng);
    if (distFromTee < 10) {
        lie = 'tee';
    }

    // Update form (if in shot screen)
    const distInput = document.getElementById('fDistance');
    const lieInput = document.getElementById('fLie');
    if (distInput) distInput.value = dist;
    if (lieInput) lieInput.value = lie;
}

function useMyGPS(hole) {
    if (!navigator.geolocation) {
        alert('GPS not available on this device');
        return;
    }

    navigator.geolocation.getCurrentPosition((position) => {
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;
        const accuracy = position.coords.accuracy; // in meters

        // Move ball marker to GPS position
        ballPosition = L.latLng(lat, lng);
        if (ballMarker) {
            ballMarker.setLatLng(ballPosition);
        }

        // Draw accuracy circle
        if (gpsCircle) {
            satMapInstance.removeLayer(gpsCircle);
        }
        gpsCircle = L.circle([lat, lng], {
            color: '#00d4aa',
            fillColor: '#00d4aa',
            fillOpacity: 0.15,
            radius: accuracy,
        }).addTo(satMapInstance);

        // Update distance and form
        updateMapDistance(hole);
        updateShotForm(hole);
        
        // Pan to GPS position
        satMapInstance.panTo([lat, lng]);
        
        // Fetch recommendation
        setTimeout(() => fetchQuickRecommendation(hole), 300);
    }, (error) => {
        alert('Could not get GPS location: ' + error.message);
    }, {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 0,
    });
}

function navigateToPrevHole() {
    const idx = currentHoles.findIndex(h => h.hole_number === selectedHole.hole_number);
    if (idx > 0) {
        selectHole(currentHoles[idx - 1]);
    }
}

function navigateToNextHole() {
    const idx = currentHoles.findIndex(h => h.hole_number === selectedHole.hole_number);
    if (idx < currentHoles.length - 1) {
        selectHole(currentHoles[idx + 1]);
    }
}

async function fetchQuickRecommendation(hole) {
    if (!ballPosition) return;
    
    const dist = Math.round(haversineDistance(
        ballPosition.lat, ballPosition.lng,
        hole.green_lat, hole.green_lng
    ));

    try {
        const res = await fetch(`${API}/api/v1/recommendation/simple`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                course_id: currentCourse?.id,
                hole_number: hole.hole_number,
                distance_to_pin: dist,
                wind_speed: 0,
                wind_direction: 'calm',
                lie: 'fairway',
                elevation_change: 0,
                player_id: localStorage.getItem('personalCaddie_playerId') || undefined,
            })
        });

        if (res.ok) {
            const rec = await res.json();
            showMapRecommendation(rec);
        }
    } catch (e) {
        // Silent fail for quick recs
    }
}

function showMapRecommendation(rec) {
    const mapDiv = document.getElementById('satMap');
    if (!mapDiv) return;

    let recCard = mapDiv.querySelector('.map-rec-card');
    if (!recCard) {
        recCard = document.createElement('div');
        recCard.className = 'map-rec-card';
        mapDiv.parentElement.appendChild(recCard);
    }

    recCard.innerHTML = `
        <div class="rec-club-name">${rec.primary_club}</div>
        <div class="rec-distance">${rec.adjusted_distance} yards ‚Ä¢ ${rec.caddie_call}</div>
        <div class="rec-confidence">${rec.confidence}% confidence</div>
        <div class="rec-expand" onclick="startShot()">See full recommendation ‚Üí</div>
    `;
    recCard.classList.add('visible');
}

function switchView(view, holeNum) {
    const satBtn = document.getElementById('viewToggleSat');
    const diagBtn = document.getElementById('viewToggleDiag');
    const satView = document.getElementById('satelliteView');
    const diagView = document.getElementById('diagramView');
    
    if (!satBtn || !diagBtn) return;
    
    if (view === 'satellite') {
        satBtn.classList.add('active');
        diagBtn.classList.remove('active');
        if (satView) satView.style.display = 'block';
        if (diagView) diagView.style.display = 'none';
        
        // Reinitialize map if needed
        if (satMapInstance) {
            setTimeout(() => satMapInstance.invalidateSize(), 100);
        }
    } else {
        diagBtn.classList.add('active');
        satBtn.classList.remove('active');
        if (satView) satView.style.display = 'none';
        if (diagView) diagView.style.display = 'block';
    }
}

// ‚îÄ‚îÄ WIND SELECTOR ‚îÄ‚îÄ
function setWind(el) {
    document.querySelectorAll('.wind-btn').forEach(b => b.classList.remove('active'));
    el.classList.add('active');
    document.getElementById('fWindDir').value = el.dataset.wind;
}

// ‚îÄ‚îÄ HOLE SVG VISUALIZATION ‚îÄ‚îÄ
function generateHoleSVG(hole, interactive) {
    const w = 300, h = 540;
    const isPar3 = hole.par === 3;
    const isPar5 = hole.par === 5;

    const fwTop = isPar3 ? 180 : 100;
    const fwBottom = h - 100;
    // Varied fairway width by par
    const fwWidth = isPar3 ? 50 : isPar5 ? 85 : 70;
    const greenY = fwTop - 10;
    const greenRx = isPar3 ? 30 : 35;
    const greenRy = isPar3 ? 22 : 25;
    const teeY = fwBottom + 30;

    // Detect hole shape from notes
    const notes = (hole.notes || '').toLowerCase();
    let holeShape = 'straight';
    
    if (isPar3) {
        holeShape = 'straight'; // Par 3s are always straight
    } else if (notes.includes('sharp left') || notes.includes('severe dogleg left')) {
        holeShape = 'dogleg_left';
    } else if (notes.includes('sharp right') || notes.includes('severe dogleg right')) {
        holeShape = 'dogleg_right';
    } else if (notes.includes('dogleg left')) {
        holeShape = 'dogleg_left';
    } else if (notes.includes('dogleg right')) {
        holeShape = 'dogleg_right';
    } else if (notes.includes('slight dogleg left')) {
        holeShape = 'slight_dogleg_left';
    } else if (notes.includes('slight dogleg right')) {
        holeShape = 'slight_dogleg_right';
    }

    // Generate fairway path based on hole shape
    let fairwayPath = '';
    const doglegPoint = fwBottom - ((fwBottom - fwTop) * 0.6); // Dogleg turn at 60% of hole
    
    if (holeShape === 'straight') {
        // Original straight fairway
        fairwayPath = `M ${w/2-fwWidth} ${fwBottom}
                 Q ${w/2-fwWidth-10} ${(fwTop+fwBottom)/2} ${w/2-fwWidth+5} ${fwTop+20}
                 Q ${w/2-15} ${fwTop} ${w/2} ${fwTop}
                 Q ${w/2+15} ${fwTop} ${w/2+fwWidth-5} ${fwTop+20}
                 Q ${w/2+fwWidth+10} ${(fwTop+fwBottom)/2} ${w/2+fwWidth} ${fwBottom} Z`;
    } else if (holeShape === 'dogleg_left') {
        // Strong left dogleg - shifts left at 60%
        const shift = 60;
        fairwayPath = `M ${w/2-fwWidth} ${fwBottom}
                 L ${w/2-fwWidth} ${doglegPoint+40}
                 Q ${w/2-fwWidth-20} ${doglegPoint} ${w/2-fwWidth-shift} ${doglegPoint-30}
                 L ${w/2-fwWidth-shift+5} ${fwTop+20}
                 Q ${w/2-shift-15} ${fwTop} ${w/2-shift} ${fwTop}
                 Q ${w/2-shift+15} ${fwTop} ${w/2+fwWidth-shift-5} ${fwTop+20}
                 L ${w/2+fwWidth-shift} ${doglegPoint-30}
                 Q ${w/2+fwWidth-20} ${doglegPoint} ${w/2+fwWidth} ${doglegPoint+40}
                 L ${w/2+fwWidth} ${fwBottom} Z`;
    } else if (holeShape === 'dogleg_right') {
        // Strong right dogleg - shifts right at 60%
        const shift = 60;
        fairwayPath = `M ${w/2-fwWidth} ${fwBottom}
                 L ${w/2-fwWidth} ${doglegPoint+40}
                 Q ${w/2-fwWidth+20} ${doglegPoint} ${w/2-fwWidth+shift} ${doglegPoint-30}
                 L ${w/2-fwWidth+shift-5} ${fwTop+20}
                 Q ${w/2+shift-15} ${fwTop} ${w/2+shift} ${fwTop}
                 Q ${w/2+shift+15} ${fwTop} ${w/2+fwWidth+shift+5} ${fwTop+20}
                 L ${w/2+fwWidth+shift} ${doglegPoint-30}
                 Q ${w/2+fwWidth+20} ${doglegPoint} ${w/2+fwWidth} ${doglegPoint+40}
                 L ${w/2+fwWidth} ${fwBottom} Z`;
    } else if (holeShape === 'slight_dogleg_left') {
        // Gentle left curve
        const shift = 30;
        fairwayPath = `M ${w/2-fwWidth} ${fwBottom}
                 Q ${w/2-fwWidth-15} ${(fwTop+fwBottom)/2} ${w/2-fwWidth-shift+5} ${fwTop+20}
                 Q ${w/2-shift-15} ${fwTop} ${w/2-shift} ${fwTop}
                 Q ${w/2-shift+15} ${fwTop} ${w/2+fwWidth-shift-5} ${fwTop+20}
                 Q ${w/2+fwWidth-5} ${(fwTop+fwBottom)/2} ${w/2+fwWidth} ${fwBottom} Z`;
    } else if (holeShape === 'slight_dogleg_right') {
        // Gentle right curve
        const shift = 30;
        fairwayPath = `M ${w/2-fwWidth} ${fwBottom}
                 Q ${w/2-fwWidth+5} ${(fwTop+fwBottom)/2} ${w/2-fwWidth+shift-5} ${fwTop+20}
                 Q ${w/2+shift-15} ${fwTop} ${w/2+shift} ${fwTop}
                 Q ${w/2+shift+15} ${fwTop} ${w/2+fwWidth+shift+5} ${fwTop+20}
                 Q ${w/2+fwWidth+15} ${(fwTop+fwBottom)/2} ${w/2+fwWidth} ${fwBottom} Z`;
    }

    // Landing zone circle for par 4s and 5s (where the drive should land)
    let landingZoneSVG = '';
    if (!isPar3) {
        const driverDistance = isPar5 ? 250 : 220; // Typical drive distance
        const landingFrac = Math.min(driverDistance / hole.distance, 0.7); // Don't go past 70%
        const landingY = fwBottom - ((fwBottom - fwTop) * landingFrac);
        
        // Position landing zone accounting for dogleg
        let landingX = w / 2;
        if (holeShape === 'dogleg_left' || holeShape === 'slight_dogleg_left') {
            if (landingFrac > 0.6) landingX -= (holeShape === 'dogleg_left' ? 60 : 30) * (landingFrac - 0.6) / 0.4;
        } else if (holeShape === 'dogleg_right' || holeShape === 'slight_dogleg_right') {
            if (landingFrac > 0.6) landingX += (holeShape === 'dogleg_right' ? 60 : 30) * (landingFrac - 0.6) / 0.4;
        }
        
        landingZoneSVG = `
            <circle cx="${landingX}" cy="${landingY}" r="18" fill="none" stroke="rgba(255,217,61,.5)" stroke-width="2" stroke-dasharray="4,3"/>
            <circle cx="${landingX}" cy="${landingY}" r="3" fill="rgba(255,217,61,.7)"/>
            <text x="${landingX}" y="${landingY+28}" text-anchor="middle" font-size="10" fill="rgba(255,217,61,.8)">${Math.round(driverDistance)}yd</text>
        `;
    }

    let hazardsSVG = '';
    (hole.hazards || []).forEach(hz => {
        const hzColor = hz.type === 'water' ? '#4fc3f7' : hz.type === 'bunker' ? '#ffcc02' : hz.type === 'out_of_bounds' ? '#ff4757' : '#2d8a4e';
        const hzOpacity = hz.type === 'water' ? 0.4 : hz.type === 'bunker' ? 0.5 : 0.3;
        let hzX = w / 2, hzY = fwBottom - ((hz.distance / hole.distance) * (fwBottom - fwTop));
        if (hz.distance === 0) hzY = greenY;

        // Adjust hazard position for doglegs
        const hazardFrac = hz.distance / hole.distance;
        if (holeShape === 'dogleg_left' || holeShape === 'slight_dogleg_left') {
            if (hazardFrac > 0.6) {
                const shift = (holeShape === 'dogleg_left' ? 60 : 30) * (hazardFrac - 0.6) / 0.4;
                hzX -= shift;
            }
        } else if (holeShape === 'dogleg_right' || holeShape === 'slight_dogleg_right') {
            if (hazardFrac > 0.6) {
                const shift = (holeShape === 'dogleg_right' ? 60 : 30) * (hazardFrac - 0.6) / 0.4;
                hzX += shift;
            }
        }

        if (hz.location === 'left') hzX = hzX - fwWidth - 15;
        else if (hz.location === 'right') hzX = hzX + fwWidth + 15;
        else if (hz.location === 'short') { hzY = greenY + 30; }
        else if (hz.location === 'long') { hzY = greenY - 30; }

        if (hz.type === 'water') {
            hazardsSVG += `<ellipse cx="${hzX}" cy="${hzY}" rx="25" ry="15" fill="${hzColor}" opacity="${hzOpacity}"/>`;
            hazardsSVG += `<text x="${hzX}" y="${hzY + 4}" text-anchor="middle" font-size="10" fill="${hzColor}">üíß</text>`;
        } else if (hz.type === 'bunker') {
            hazardsSVG += `<ellipse cx="${hzX}" cy="${hzY}" rx="18" ry="10" fill="${hzColor}" opacity="${hzOpacity}"/>`;
        } else if (hz.type === 'out_of_bounds') {
            const x1 = hz.location === 'left' ? 10 : w - 10;
            hazardsSVG += `<line x1="${x1}" y1="${fwTop}" x2="${x1}" y2="${fwBottom}" stroke="${hzColor}" stroke-width="3" stroke-dasharray="8,4" opacity="0.6"/>`;
            hazardsSVG += `<text x="${x1}" y="${(fwTop+fwBottom)/2}" text-anchor="middle" font-size="9" fill="${hzColor}" transform="rotate(-90,${x1},${(fwTop+fwBottom)/2})">OB</text>`;
        } else {
            hazardsSVG += `<rect x="${hzX-15}" y="${hzY-15}" width="30" height="30" rx="8" fill="${hzColor}" opacity="${hzOpacity}"/>`;
            hazardsSVG += `<text x="${hzX}" y="${hzY + 4}" text-anchor="middle" font-size="10" fill="${hzColor}">üå≤</text>`;
        }
    });

    const distLines = [100, 150, 200];
    if (hole.distance > 350) distLines.push(250);
    if (hole.distance > 500) distLines.push(300);

    const markersSVG = distLines.filter(d => d < hole.distance - 30).map(d => {
        const distFrac = d / hole.distance;
        const y = fwBottom - ((fwBottom - fwTop) * distFrac);
        
        // Adjust distance markers for doglegs
        let markerCenterX = w / 2;
        if (holeShape === 'dogleg_left' || holeShape === 'slight_dogleg_left') {
            if (distFrac > 0.6) {
                const shift = (holeShape === 'dogleg_left' ? 60 : 30) * (distFrac - 0.6) / 0.4;
                markerCenterX -= shift;
            }
        } else if (holeShape === 'dogleg_right' || holeShape === 'slight_dogleg_right') {
            if (distFrac > 0.6) {
                const shift = (holeShape === 'dogleg_right' ? 60 : 30) * (distFrac - 0.6) / 0.4;
                markerCenterX += shift;
            }
        }
        
        const color = d === 150 ? 'rgba(0,212,170,.4)' : 'rgba(255,255,255,.15)';
        const textColor = d === 150 ? 'rgba(0,212,170,.6)' : 'rgba(255,255,255,.3)';
        const sw = d === 150 ? '1.5' : '1';
        return `
            <line x1="${markerCenterX-fwWidth+10}" y1="${y}" x2="${markerCenterX+fwWidth-10}" y2="${y}" stroke="${color}" stroke-width="${sw}" stroke-dasharray="4,4"/>
            <text x="${markerCenterX+fwWidth+5}" y="${y+4}" font-size="9" fill="${textColor}" font-weight="${d===150?'bold':'normal'}">${d}</text>
            <text x="${markerCenterX-fwWidth-2}" y="${y+4}" font-size="9" fill="${textColor}" text-anchor="end">${d}</text>
        `;
    }).join('');

    // Adjust green position for doglegs
    let greenX = w / 2;
    if (holeShape === 'dogleg_left') greenX -= 60;
    else if (holeShape === 'dogleg_right') greenX += 60;
    else if (holeShape === 'slight_dogleg_left') greenX -= 30;
    else if (holeShape === 'slight_dogleg_right') greenX += 30;

    return `<svg viewBox="0 0 ${w} ${h}" xmlns="http://www.w3.org/2000/svg">
        <rect width="${w}" height="${h}" fill="#0a1510"/>
        <path d="${fairwayPath}" fill="#1a4d2e" stroke="#2a6b3e" stroke-width="1"/>
        ${landingZoneSVG}
        <ellipse cx="${greenX}" cy="${greenY}" rx="${greenRx}" ry="${greenRy}" fill="#2d8a4e" stroke="#3da65e" stroke-width="1.5"/>
        <line x1="${greenX}" y1="${greenY-18}" x2="${greenX}" y2="${greenY-2}" stroke="white" stroke-width="1.5"/>
        <polygon points="${greenX},${greenY-18} ${greenX+10},${greenY-13} ${greenX},${greenY-8}" fill="#ff4757"/>
        <rect x="${w/2-20}" y="${teeY-6}" width="40" height="12" rx="3" fill="#4a7c59" stroke="#5a9c6a" stroke-width="1"/>
        <text x="${w/2}" y="${teeY+22}" text-anchor="middle" font-size="12" font-weight="bold" fill="white">${hole.distance} yds</text>
        ${markersSVG}
        ${hazardsSVG}
        <text x="16" y="30" font-size="14" font-weight="bold" fill="rgba(255,255,255,.5)">#${hole.hole_number}</text>
        <text x="${w-16}" y="30" text-anchor="end" font-size="12" fill="rgba(255,255,255,.3)">Par ${hole.par}</text>
    </svg>`;
}

// ‚îÄ‚îÄ INTERACTIVE HOLE TAP (for SVG diagram) ‚îÄ‚îÄ
let playerPosition = null;

function redrawPlayerMarker() {
    if (!playerPosition) return;
    
    const svgContainer = document.getElementById('holeVizSvg');
    if (!svgContainer) return;
    
    const svg = svgContainer.querySelector('svg');
    if (!svg) return;
    
    const old = svg.querySelector('#playerMarker');
    if (old) old.remove();
    
    const svgW = 300, svgH = 540;
    const px = playerPosition.relX * svgW;
    const py = playerPosition.relY * svgH;
    
    const marker = document.createElementNS('http://www.w3.org/2000/svg', 'g');
    marker.id = 'playerMarker';
    marker.innerHTML = `
        <circle cx="${px}" cy="${py}" r="8" fill="var(--accent,#00d4aa)" opacity="0.9" stroke="white" stroke-width="2"/>
        <circle cx="${px}" cy="${py}" r="3" fill="white"/>
        <rect x="${px-35}" y="${py+14}" width="70" height="22" rx="6" fill="rgba(0,0,0,.8)"/>
        <text x="${px}" y="${py+29}" text-anchor="middle" font-size="12" font-weight="bold" fill="#00d4aa">${playerPosition.distToPin} yds</text>
    `;
    svg.appendChild(marker);
}

function handleHoleTap(event, holeNum) {
    const container = event.currentTarget;
    const rect = container.getBoundingClientRect();
    const clickY = event.clientY - rect.top;
    const clickX = event.clientX - rect.left;
    const relY = clickY / rect.height;
    const relX = clickX / rect.width;

    const hole = selectedHole || currentHoles.find(h => h.hole_number === holeNum);
    if (!hole) return;

    const greenFrac = 0.15;
    const teeFrac = 0.85;

    if (relY < greenFrac || relY > teeFrac + 0.05) return;

    const distFrac = (relY - greenFrac) / (teeFrac - greenFrac);
    const distToPin = Math.round(distFrac * hole.distance);
    
    const centerFrac = 0.5;
    const fwHalf = 0.15;
    let lie = 'fairway';
    if (Math.abs(relX - centerFrac) > fwHalf + 0.05) lie = 'rough';
    
    playerPosition = { distToPin, lie, relX, relY };

    const svgContainer = document.getElementById('holeVizSvg');
    if (svgContainer) {
        const svg = svgContainer.querySelector('svg');
        if (svg) {
            const old = svg.querySelector('#playerMarker');
            if (old) old.remove();
            
            const svgW = 300, svgH = 540;
            const px = relX * svgW;
            const py = relY * svgH;
            
            const marker = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            marker.id = 'playerMarker';
            marker.innerHTML = `
                <circle cx="${px}" cy="${py}" r="8" fill="var(--accent,#00d4aa)" opacity="0.9" stroke="white" stroke-width="2"/>
                <circle cx="${px}" cy="${py}" r="3" fill="white"/>
                <rect x="${px-35}" y="${py+14}" width="70" height="22" rx="6" fill="rgba(0,0,0,.8)"/>
                <text x="${px}" y="${py+29}" text-anchor="middle" font-size="12" font-weight="bold" fill="#00d4aa">${distToPin} yds</text>
            `;
            svg.appendChild(marker);
        }
    }

    document.getElementById('fDistance').value = distToPin;
    document.getElementById('fLie').value = lie === 'rough' ? 'rough' : 'fairway';
    
    const hint = document.querySelector('.tap-hint');
    if (hint) {
        hint.textContent = `üìç ${distToPin} yards to pin ‚Ä¢ ${lie} ‚Ä¢ Tap "Get Club" below`;
        hint.style.opacity = '1';
        hint.style.color = 'var(--accent)';
    }
}

// ‚îÄ‚îÄ SHOT ADVISOR ‚îÄ‚îÄ
function startShot() {
    showScreen('shot');
    if (selectedHole) {
        // Use ballPosition from map if exists, else playerPosition from SVG, else full hole distance
        let dist = selectedHole.distance;
        let lie = 'fairway';
        
        if (ballPosition) {
            dist = Math.round(haversineDistance(
                ballPosition.lat, ballPosition.lng,
                selectedHole.green_lat, selectedHole.green_lng
            ));
        } else if (playerPosition && playerPosition.distToPin) {
            dist = playerPosition.distToPin;
            lie = playerPosition.lie || 'fairway';
        }
        
        document.getElementById('fDistance').value = dist;
        document.getElementById('fLie').value = lie;
        document.getElementById('fElev').value = selectedHole.elevation_change || 0;
        
        document.getElementById('shotHoleViz').innerHTML = `
            <div class="hole-viz" style="margin-bottom:16px">
                <div class="hole-viz-header">
                    <h3>${currentCourse?.name || 'Course'} ‚Äî Hole ${selectedHole.hole_number}</h3>
                    <span class="badge badge-par${selectedHole.par === 3 ? '3' : selectedHole.par === 5 ? '5' : '4'}">Par ${selectedHole.par}</span>
                </div>
                <div class="hole-svg-container" onclick="handleHoleTap(event, ${selectedHole.hole_number})" id="holeVizSvg">${generateHoleSVG(selectedHole)}</div>
                <div class="tap-hint">üëÜ Tap your position on the hole to auto-calculate distance</div>
            </div>
        `;
        
        if (playerPosition) {
            redrawPlayerMarker();
        }
    }
}

async function getRecommendation() {
    const btn = document.getElementById('btnRecommend');
    const result = document.getElementById('recResult');
    btn.disabled = true;
    btn.textContent = 'Analyzing...';
    result.innerHTML = '<div class="loading"><div class="spinner"></div>Your caddie is thinking...</div>';

    const courseId = currentCourse?.id || (allCourses[0]?.id);
    const holeNum = selectedHole?.hole_number || 1;

    try {
        const res = await fetch(`${API}/api/v1/recommendation/simple`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                course_id: courseId,
                hole_number: holeNum,
                distance_to_pin: parseInt(document.getElementById('fDistance').value) || 150,
                wind_speed: parseInt(document.getElementById('fWind').value) || 0,
                wind_direction: document.getElementById('fWindDir').value,
                lie: document.getElementById('fLie').value,
                elevation_change: parseInt(document.getElementById('fElev').value) || 0,
                player_id: localStorage.getItem('personalCaddie_playerId') || undefined,
            })
        });

        if (!res.ok) {
            let detail = `HTTP ${res.status}`;
            try { const err = await res.json(); detail = err.detail || detail; } catch(e) {}
            throw new Error(detail);
        }

        const rec = await res.json();
        result.innerHTML = `
            <div class="rec-card">
                <div class="rec-club">${rec.primary_club}</div>
                <div class="rec-call">"${rec.caddie_call}"</div>
                <div class="rec-stats">
                    <div class="rec-stat">
                        <div class="rec-stat-val">${rec.adjusted_distance}</div>
                        <div class="rec-stat-label">Yards</div>
                    </div>
                    <div class="rec-stat">
                        <div class="rec-stat-val">${rec.confidence}%</div>
                        <div class="rec-stat-label">Confidence</div>
                    </div>
                    <div class="rec-stat">
                        <div class="rec-stat-val">${rec.optimal_miss?.split(' ')[1] || '‚Äî'}</div>
                        <div class="rec-stat-label">Miss To</div>
                    </div>
                </div>
                <div class="rec-detail">
                    <h4>Why This Club</h4>
                    <p>${rec.why || ''}</p>
                </div>
                <div class="rec-detail">
                    <h4>Target</h4>
                    <p>${rec.primary_target || ''}</p>
                </div>
                ${rec.danger_zone ? `<div class="rec-detail"><h4>‚ö†Ô∏è Danger Zone</h4><p style="color:var(--danger)">${rec.danger_zone}</p></div>` : ''}
                ${rec.risk_reward ? `
                <div class="rec-risk">
                    <div class="rec-risk-item risk-agg">
                        <div class="risk-label">üî• Aggressive</div>
                        <div>‚Üë ${rec.risk_reward.aggressive_upside}</div>
                        <div>‚Üì ${rec.risk_reward.aggressive_downside}</div>
                    </div>
                    <div class="rec-risk-item risk-con">
                        <div class="risk-label">üõ°Ô∏è Conservative</div>
                        <div>‚Üë ${rec.risk_reward.conservative_upside}</div>
                        <div>‚Üì ${rec.risk_reward.conservative_downside}</div>
                    </div>
                </div>` : ''}
                ${rec.alternatives?.length ? `
                <div class="rec-alts">
                    <div class="section-title" style="margin-top:16px;margin-bottom:8px">Alternatives</div>
                    ${rec.alternatives.map(a => `
                        <div class="rec-alt">
                            <div class="rec-alt-club">${a.club}</div>
                            <div class="rec-alt-scenario">${a.scenario}</div>
                        </div>
                    `).join('')}
                </div>` : ''}
                ${rec.caddie_note ? `<div class="caddie-note">üß¢ ${rec.caddie_note}</div>` : ''}
            </div>
        `;
    } catch (e) {
        result.innerHTML = `<div class="error-msg">‚ùå ${e.message}</div>`;
    } finally {
        btn.disabled = false;
        btn.textContent = 'Get Club';
    }
}

// ‚îÄ‚îÄ MY BAG ‚îÄ‚îÄ
const ALL_CLUBS = [
    { type: 'driver', name: 'Driver', category: 'Woods' },
    { type: 'wood_3', name: '3 Wood', category: 'Woods' },
    { type: 'wood_5', name: '5 Wood', category: 'Woods' },
    { type: 'wood_7', name: '7 Wood', category: 'Woods' },
    { type: 'hybrid_2', name: '2H', category: 'Hybrids' },
    { type: 'hybrid_3', name: '3H', category: 'Hybrids' },
    { type: 'hybrid_4', name: '4H', category: 'Hybrids' },
    { type: 'hybrid_5', name: '5H', category: 'Hybrids' },
    { type: 'hybrid_6', name: '6H', category: 'Hybrids' },
    { type: 'iron_2', name: '2 Iron', category: 'Irons' },
    { type: 'iron_3', name: '3 Iron', category: 'Irons' },
    { type: 'iron_4', name: '4 Iron', category: 'Irons' },
    { type: 'iron_5', name: '5 Iron', category: 'Irons' },
    { type: 'iron_6', name: '6 Iron', category: 'Irons' },
    { type: 'iron_7', name: '7 Iron', category: 'Irons' },
    { type: 'iron_8', name: '8 Iron', category: 'Irons' },
    { type: 'iron_9', name: '9 Iron', category: 'Irons' },
    { type: 'pitching_wedge', name: 'PW', category: 'Wedges', degree: 46 },
    { type: 'gap_wedge', name: 'GW', category: 'Wedges', degree: 52 },
    { type: 'sand_wedge', name: 'SW', category: 'Wedges', degree: 56 },
    { type: 'lob_wedge', name: 'LW', category: 'Wedges', degree: 60 },
];

const PRESETS = {
    beginner:  { driver:180, wood_3:170, wood_5:160, hybrid_4:150, hybrid_5:142, iron_5:140, iron_6:130, iron_7:120, iron_8:110, iron_9:100, pitching_wedge:85, sand_wedge:60, lob_wedge:45 },
    average:   { driver:210, wood_3:200, wood_5:190, hybrid_3:182, hybrid_4:175, iron_5:160, iron_6:150, iron_7:140, iron_8:130, iron_9:120, pitching_wedge:105, gap_wedge:90, sand_wedge:75, lob_wedge:58 },
    advanced:  { driver:240, wood_3:225, wood_5:215, hybrid_3:208, hybrid_4:198, iron_4:190, iron_5:180, iron_6:170, iron_7:160, iron_8:150, iron_9:140, pitching_wedge:125, gap_wedge:110, sand_wedge:95, lob_wedge:70 },
    scratch:   { driver:270, wood_3:250, wood_5:240, hybrid_2:232, hybrid_3:225, iron_4:215, iron_5:200, iron_6:190, iron_7:178, iron_8:165, iron_9:155, pitching_wedge:140, gap_wedge:125, sand_wedge:110, lob_wedge:85 },
};

let bagState = {};

function initBag() {
    ALL_CLUBS.forEach(club => {
        if (!bagState[club.type]) {
            bagState[club.type] = { inBag: false, carry: '', total: '', degree: club.degree || null };
        }
    });
    
    const saved = localStorage.getItem('personalCaddie_bag');
    if (saved) {
        try {
            const data = JSON.parse(saved);
            Object.entries(data.clubs || {}).forEach(([type, state]) => {
                if (bagState[type]) {
                    bagState[type] = { ...bagState[type], ...state };
                }
            });
            document.getElementById('bagPlayerName').value = data.playerName || '';
            document.getElementById('bagMiss').value = data.miss || '';
            document.getElementById('bagShortGame').value = data.shortGame || '';
            document.getElementById('bagMeasure').value = data.measure || 'estimated';
            document.getElementById('bagSpeed').value = data.speed || '';
        } catch(e) {}
    }
    renderBagClubs();
}

function renderBagClubs() {
    const container = document.getElementById('bagClubList');
    let html = '';
    let currentCat = '';
    ALL_CLUBS.forEach(club => {
        if (club.category !== currentCat) {
            currentCat = club.category;
            html += `<div class="bag-section-title" style="margin-top:16px">${currentCat}</div>`;
        }
        const state = bagState[club.type] || { inBag: false, carry: '', total: '', degree: club.degree || null };
        const active = state.inBag;
        const isWedge = club.category === 'Wedges';
        const displayName = isWedge && state.degree ? `${club.name} (${state.degree}¬∞)` : club.name;
        
        html += `
            <div class="club-row ${active ? 'in-bag' : ''}" id="clubRow_${club.type}">
                <button class="club-toggle ${active ? 'active' : ''}" onclick="toggleClub('${club.type}')" id="clubTog_${club.type}">
                    ${active ? '‚úì' : '+'}
                </button>
                <div class="club-name" style="flex:${isWedge ? '0.8' : '1'}">${displayName}</div>
                ${isWedge ? `
                <div class="club-dist-group" style="width:55px">
                    <input type="number" class="club-dist-input" id="degree_${club.type}" 
                        value="${state.degree || club.degree || ''}" placeholder="¬∞" min="42" max="64" step="1"
                        oninput="updateClubDegree('${club.type}')" ${!active ? 'disabled' : ''} style="width:50px">
                    <span class="club-dist-label">Loft¬∞</span>
                </div>` : ''}
                <div class="club-distance-inputs">
                    <div class="club-dist-group">
                        <input type="number" class="club-dist-input" id="carry_${club.type}" 
                            value="${state.carry || ''}" placeholder="‚Äî" min="0" max="400"
                            oninput="updateClubDist('${club.type}')" ${!active ? 'disabled' : ''}>
                        <span class="club-dist-label">Carry</span>
                    </div>
                    <div class="club-dist-group">
                        <input type="number" class="club-dist-input" id="total_${club.type}" 
                            value="${state.total || ''}" placeholder="‚Äî" min="0" max="450"
                            oninput="updateClubDist('${club.type}')" ${!active ? 'disabled' : ''}>
                        <span class="club-dist-label">Total</span>
                    </div>
                </div>
            </div>`;
    });
    container.innerHTML = html;
    updateBagCount();
}

function toggleClub(type) {
    const club = ALL_CLUBS.find(c => c.type === type);
    if (!bagState[type]) bagState[type] = { inBag: false, carry: '', total: '', degree: club?.degree || null };
    bagState[type].inBag = !bagState[type].inBag;
    
    const row = document.getElementById('clubRow_' + type);
    const tog = document.getElementById('clubTog_' + type);
    const carryInput = document.getElementById('carry_' + type);
    const totalInput = document.getElementById('total_' + type);
    const degreeInput = document.getElementById('degree_' + type);
    
    if (bagState[type].inBag) {
        row.classList.add('in-bag');
        tog.classList.add('active');
        tog.textContent = '‚úì';
        carryInput.disabled = false;
        totalInput.disabled = false;
        if (degreeInput) degreeInput.disabled = false;
        carryInput.focus();
    } else {
        row.classList.remove('in-bag');
        tog.classList.remove('active');
        tog.textContent = '+';
        carryInput.disabled = true;
        totalInput.disabled = true;
        if (degreeInput) degreeInput.disabled = true;
    }
    updateBagCount();
}

function updateClubDist(type) {
    if (!bagState[type]) bagState[type] = { inBag: true, carry: '', total: '', degree: null };
    const carry = parseInt(document.getElementById('carry_' + type).value) || '';
    const total = parseInt(document.getElementById('total_' + type).value) || '';
    bagState[type].carry = carry;
    bagState[type].total = total;
    if (carry && !total) {
        const autoTotal = Math.round(carry * 1.05);
        document.getElementById('total_' + type).value = autoTotal;
        bagState[type].total = autoTotal;
    }
}

function updateClubDegree(type) {
    if (!bagState[type]) bagState[type] = { inBag: true, carry: '', total: '', degree: null };
    const degree = parseInt(document.getElementById('degree_' + type).value) || null;
    bagState[type].degree = degree;
    const club = ALL_CLUBS.find(c => c.type === type);
    const displayName = degree ? `${club.name} (${degree}¬∞)` : club.name;
    const nameDiv = document.querySelector(`#clubRow_${type} .club-name`);
    if (nameDiv) nameDiv.textContent = displayName;
}

function updateBagCount() {
    const count = Object.values(bagState).filter(s => s.inBag).length;
    const el = document.getElementById('bagClubCount');
    el.textContent = count;
    el.style.color = count > 14 ? 'var(--danger)' : 'var(--accent)';
}

function applyPreset(level) {
    document.querySelectorAll('.bag-preset-btn').forEach(b => b.classList.remove('active'));
    event.target.classList.add('active');
    
    const preset = PRESETS[level];
    bagState = {};
    ALL_CLUBS.forEach(club => {
        if (preset[club.type] !== undefined) {
            const carry = preset[club.type];
            const total = Math.round(carry * 1.06);
            bagState[club.type] = { inBag: true, carry, total, degree: club.degree || null };
        } else {
            bagState[club.type] = { inBag: false, carry: '', total: '', degree: club.degree || null };
        }
    });
    renderBagClubs();
}

async function saveBag() {
    const btn = document.getElementById('bagSaveBtn');
    const status = document.getElementById('bagStatus');
    const playerName = document.getElementById('bagPlayerName').value.trim();
    
    if (!playerName) {
        status.className = 'bag-status error';
        status.textContent = 'Please enter your name';
        return;
    }
    
    const clubsInBag = Object.entries(bagState).filter(([_, s]) => s.inBag && s.carry);
    if (clubsInBag.length === 0) {
        status.className = 'bag-status error';
        status.textContent = 'Add at least one club with a distance';
        return;
    }
    
    btn.disabled = true;
    btn.textContent = 'Saving...';
    
    const measure = document.getElementById('bagMeasure').value;
    const playerId = playerName.toLowerCase().replace(/[^a-z0-9]/g, '_').substring(0, 50);
    
    const payload = {
        player_id: playerId,
        player_name: playerName,
        created_date: new Date().toISOString(),
        club_distances: clubsInBag.map(([type, s]) => ({
            club_type: type,
            carry_distance: parseInt(s.carry),
            total_distance: parseInt(s.total) || Math.round(parseInt(s.carry) * 1.05),
            measurement_method: measure,
        })),
        general_characteristics: {},
    };
    
    const miss = document.getElementById('bagMiss').value;
    const shortGame = document.getElementById('bagShortGame').value;
    const speed = document.getElementById('bagSpeed').value;
    if (miss) payload.general_characteristics.miss_pattern = miss;
    if (shortGame) payload.general_characteristics.short_game_strength = shortGame;
    if (speed) payload.general_characteristics.typical_swing_speed = parseInt(speed);
    
    try {
        const res = await fetch(`${API}/api/v1/players/baseline`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
        });
        
        if (!res.ok) {
            let detail = `HTTP ${res.status}`;
            try { const err = await res.json(); detail = err.detail || JSON.stringify(err) ; } catch(e) {}
            throw new Error(detail);
        }
        
        const data = await res.json();
        
        localStorage.setItem('personalCaddie_bag', JSON.stringify({
            playerName,
            playerId,
            clubs: bagState,
            miss: document.getElementById('bagMiss').value,
            shortGame: document.getElementById('bagShortGame').value,
            measure,
            speed: document.getElementById('bagSpeed').value,
        }));
        
        localStorage.setItem('personalCaddie_playerId', playerId);
        
        status.className = 'bag-status success';
        status.textContent = `‚úÖ Bag saved! ${data.clubs_registered} clubs registered for ${playerName}`;
    } catch(e) {
        status.className = 'bag-status error';
        status.textContent = `‚ùå ${e.message}`;
    } finally {
        btn.disabled = false;
        btn.textContent = 'üíæ Save My Bag';
    }
}

async function loadExistingBag() {
    const playerId = localStorage.getItem('personalCaddie_playerId');
    if (!playerId) return;
    try {
        const res = await fetch(`${API}/api/v1/players/${playerId}/baseline`);
        if (res.ok) {
            const data = await res.json();
            document.getElementById('bagPlayerName').value = data.player_name || '';
            ALL_CLUBS.forEach(club => {
                if (!bagState[club.type]) {
                    bagState[club.type] = { inBag: false, carry: '', total: '', degree: club.degree || null };
                }
            });
            (data.club_distances || []).forEach(cd => {
                const club = ALL_CLUBS.find(c => c.type === cd.club_type);
                bagState[cd.club_type] = { 
                    inBag: true, 
                    carry: cd.carry_distance, 
                    total: cd.total_distance,
                    degree: club?.degree || null
                };
            });
            if (data.general_characteristics) {
                if (data.general_characteristics.miss_pattern) document.getElementById('bagMiss').value = data.general_characteristics.miss_pattern;
                if (data.general_characteristics.short_game_strength) document.getElementById('bagShortGame').value = data.general_characteristics.short_game_strength;
                if (data.general_characteristics.typical_swing_speed) document.getElementById('bagSpeed').value = data.general_characteristics.typical_swing_speed;
            }
            renderBagClubs();
        }
    } catch(e) { /* silent */ }
}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
loadCourses();
initBag();
loadExistingBag();
</script>
</body>
</html>
