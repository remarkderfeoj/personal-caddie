<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1a1a2e">
    <title>Personal Caddie</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚õ≥</text></svg>">
    <style>
        :root {
            --bg: #0f1923;
            --bg2: #1a2332;
            --card: #1e2d3d;
            --card-hover: #243447;
            --accent: #00d4aa;
            --accent2: #00b894;
            --text: #e8e8e8;
            --text2: #8899aa;
            --danger: #ff6b6b;
            --water: #4fc3f7;
            --sand: #ffcc02;
            --trees: #2d8a4e;
            --ob: #ff4757;
            --par3: #4fc3f7;
            --par4: #00d4aa;
            --par5: #ffd93d;
            --radius: 16px;
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }
        .app { max-width: 480px; margin: 0 auto; padding-bottom: 100px; }

        /* ‚îÄ‚îÄ NAV ‚îÄ‚îÄ */
        nav {
            position: sticky; top: 0; z-index: 100;
            background: rgba(15,25,35,.92);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 16px 20px;
            display: flex; align-items: center; justify-content: space-between;
            border-bottom: 1px solid rgba(255,255,255,.06);
        }
        .logo { font-size: 20px; font-weight: 700; display: flex; align-items: center; gap: 8px; }
        .logo span { color: var(--accent); }
        .nav-back { background:none; border:none; color:var(--accent); font-size:16px; cursor:pointer; display:none; padding:4px 8px; }

        /* ‚îÄ‚îÄ SCREENS ‚îÄ‚îÄ */
        .screen { display: none; padding: 20px; }
        .screen.active { display: block; }

        /* ‚îÄ‚îÄ FEATURED COURSES ‚îÄ‚îÄ */
        .section-title {
            font-size: 13px; font-weight: 600; text-transform: uppercase;
            letter-spacing: 2px; color: var(--text2); margin: 24px 0 12px; padding: 0 4px;
        }
        .search-box {
            width: 100%; padding: 14px 18px; padding-left: 44px;
            background: var(--card); border: 1px solid rgba(255,255,255,.08);
            border-radius: var(--radius); color: var(--text); font-size: 16px;
            outline: none; transition: all .2s;
        }
        .search-box:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(0,212,170,.15); }
        .search-wrap { position: relative; margin-bottom: 8px; }
        .search-icon {
            position: absolute; left: 16px; top: 50%; transform: translateY(-50%);
            color: var(--text2); font-size: 16px; pointer-events: none;
        }

        .course-grid { display: flex; flex-direction: column; gap: 12px; }
        .course-card {
            background: var(--card); border-radius: var(--radius);
            padding: 20px; cursor: pointer; transition: all .2s;
            border: 1px solid transparent; position: relative; overflow: hidden;
        }
        .course-card:active { transform: scale(.98); }
        .course-card:hover { border-color: rgba(0,212,170,.3); background: var(--card-hover); }
        .course-card-name { font-size: 17px; font-weight: 600; margin-bottom: 6px; }
        .course-card-meta { display: flex; gap: 16px; color: var(--text2); font-size: 13px; }
        .course-card-meta span { display: flex; align-items: center; gap: 4px; }
        .course-card-badge {
            position: absolute; top: 16px; right: 16px;
            background: rgba(0,212,170,.15); color: var(--accent);
            padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600;
        }
        .featured-badge { background: rgba(255,217,61,.15); color: #ffd93d; }

        /* ‚îÄ‚îÄ COURSE DETAIL / HOLE VIEW ‚îÄ‚îÄ */
        .course-header {
            background: linear-gradient(135deg, #1a3a2a 0%, #0f2b1f 100%);
            border-radius: var(--radius); padding: 24px; margin-bottom: 20px;
            border: 1px solid rgba(0,212,170,.15);
        }
        .course-header h2 { font-size: 22px; margin-bottom: 8px; }
        .course-header-stats { display: flex; gap: 20px; color: var(--text2); font-size: 13px; }

        .holes-grid { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px; }
        .hole-chip {
            width: 48px; height: 48px; border-radius: 12px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: var(--card); cursor: pointer; transition: all .2s;
            border: 2px solid transparent; font-size: 14px; font-weight: 600;
        }
        .hole-chip:active { transform: scale(.95); }
        .hole-chip.active { border-color: var(--accent); background: rgba(0,212,170,.1); }
        .hole-chip .par-dot {
            width: 6px; height: 6px; border-radius: 50%; margin-top: 3px;
        }
        .par3-dot { background: var(--par3); }
        .par4-dot { background: var(--par4); }
        .par5-dot { background: var(--par5); }

        /* ‚îÄ‚îÄ HOLE VISUALIZATION ‚îÄ‚îÄ */
        .hole-viz {
            background: var(--card); border-radius: var(--radius);
            padding: 20px; margin-bottom: 16px;
            border: 1px solid rgba(255,255,255,.06);
        }
        .hole-viz-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;
        }
        .hole-viz-header h3 { font-size: 18px; }
        .hole-viz-badges { display: flex; gap: 8px; }
        .badge {
            padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600;
        }
        .badge-par3 { background: rgba(79,195,247,.15); color: var(--par3); }
        .badge-par4 { background: rgba(0,212,170,.15); color: var(--par4); }
        .badge-par5 { background: rgba(255,217,61,.15); color: var(--par5); }

        .hole-svg-container {
            width: 100%; aspect-ratio: 1/1.8; background: #0a1510;
            border-radius: 12px; overflow: hidden; margin-bottom: 12px;
            position: relative; cursor: crosshair;
        }
        .hole-svg-container svg { width: 100%; height: 100%; }
        .tap-hint {
            font-size: 11px; color: var(--text2); text-align: center;
            margin-top: -8px; margin-bottom: 12px; opacity: .6;
        }

        /* Wind compass */
        .wind-compass {
            display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px;
        }
        .wind-btn {
            padding: 10px 4px; border-radius: 8px;
            background: var(--bg); border: 1px solid rgba(255,255,255,.1);
            color: var(--text2); font-size: 11px; text-align: center;
            cursor: pointer; transition: all .2s;
        }
        .wind-btn.active { border-color: var(--accent); color: var(--accent); background: rgba(0,212,170,.08); }
        .wind-btn:active { transform: scale(.95); }

        .hole-info-row {
            display: flex; justify-content: space-between; padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,.06); font-size: 14px;
        }
        .hole-info-row:last-child { border-bottom: none; }
        .hole-info-label { color: var(--text2); }
        .hole-info-value { font-weight: 600; }

        .hazard-list { margin-top: 12px; }
        .hazard-chip {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 6px 12px; border-radius: 20px; font-size: 12px;
            margin: 4px 4px 4px 0;
        }
        .hazard-water { background: rgba(79,195,247,.15); color: var(--water); }
        .hazard-bunker { background: rgba(255,204,2,.15); color: var(--sand); }
        .hazard-ob { background: rgba(255,71,87,.15); color: var(--ob); }
        .hazard-trees { background: rgba(45,138,78,.15); color: var(--trees); }

        /* ‚îÄ‚îÄ SHOT FORM ‚îÄ‚îÄ */
        .shot-form {
            background: var(--card); border-radius: var(--radius);
            padding: 24px; border: 1px solid rgba(255,255,255,.06);
        }
        .shot-form h3 { font-size: 16px; margin-bottom: 20px; color: var(--accent); }
        .form-row { display: flex; gap: 12px; margin-bottom: 16px; }
        .form-group { flex: 1; }
        .form-group label {
            display: block; font-size: 11px; font-weight: 600;
            text-transform: uppercase; letter-spacing: 1px;
            color: var(--text2); margin-bottom: 6px;
        }
        .form-group input, .form-group select {
            width: 100%; padding: 12px 14px;
            background: var(--bg); border: 1px solid rgba(255,255,255,.1);
            border-radius: 10px; color: var(--text); font-size: 15px;
        }
        .form-group input:focus, .form-group select:focus {
            outline: none; border-color: var(--accent);
        }
        .form-group select { appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath d='M2 4l4 4 4-4' fill='none' stroke='%238899aa' stroke-width='1.5'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; padding-right: 32px; }

        .btn-recommend {
            width: 100%; padding: 16px; margin-top: 8px;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent2) 100%);
            color: #000; border: none; border-radius: 12px;
            font-size: 16px; font-weight: 700; cursor: pointer;
            text-transform: uppercase; letter-spacing: 1px;
            transition: all .2s; box-shadow: 0 4px 20px rgba(0,212,170,.3);
        }
        .btn-recommend:active { transform: scale(.98); opacity: .9; }
        .btn-recommend:disabled { opacity: .4; cursor: not-allowed; }

        /* ‚îÄ‚îÄ RECOMMENDATION RESULT ‚îÄ‚îÄ */
        .rec-card {
            background: linear-gradient(135deg, #0a2a1a 0%, #1a3a2a 100%);
            border-radius: var(--radius); padding: 24px;
            border: 1px solid rgba(0,212,170,.2); margin-top: 16px;
        }
        .rec-club { font-size: 36px; font-weight: 800; text-align: center; color: var(--accent); margin-bottom: 4px; }
        .rec-call { text-align: center; font-size: 16px; color: var(--text2); margin-bottom: 20px; font-style: italic; }
        .rec-stats { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        .rec-stat { text-align: center; }
        .rec-stat-val { font-size: 22px; font-weight: 700; color: var(--accent); }
        .rec-stat-label { font-size: 11px; color: var(--text2); text-transform: uppercase; letter-spacing: .5px; margin-top: 2px; }
        .rec-detail {
            background: rgba(0,0,0,.2); border-radius: 12px; padding: 16px; margin-bottom: 12px;
        }
        .rec-detail h4 { font-size: 12px; text-transform: uppercase; letter-spacing: 1px; color: var(--accent); margin-bottom: 8px; }
        .rec-detail p { font-size: 14px; line-height: 1.5; color: var(--text2); }
        .rec-risk {
            display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px;
        }
        .rec-risk-item { font-size: 12px; padding: 10px; border-radius: 10px; }
        .risk-agg { background: rgba(255,217,61,.08); border: 1px solid rgba(255,217,61,.15); }
        .risk-con { background: rgba(79,195,247,.08); border: 1px solid rgba(79,195,247,.15); }
        .risk-label { font-weight: 600; margin-bottom: 4px; }
        .risk-agg .risk-label { color: #ffd93d; }
        .risk-con .risk-label { color: #4fc3f7; }

        .rec-alts { margin-top: 16px; }
        .rec-alt {
            display: flex; align-items: center; gap: 12px;
            background: rgba(0,0,0,.2); border-radius: 10px; padding: 12px; margin-top: 8px;
        }
        .rec-alt-club { font-weight: 700; color: var(--text); min-width: 80px; }
        .rec-alt-scenario { font-size: 12px; color: var(--text2); }

        .caddie-note {
            text-align: center; padding: 16px; margin-top: 12px;
            font-style: italic; color: var(--text2); font-size: 14px;
            border-top: 1px solid rgba(255,255,255,.06);
        }

        /* ‚îÄ‚îÄ ERROR ‚îÄ‚îÄ */
        .error-msg {
            background: rgba(255,107,107,.1); border: 1px solid rgba(255,107,107,.2);
            border-radius: 12px; padding: 16px; color: var(--danger);
            text-align: center; font-size: 14px; margin-top: 16px;
        }

        /* ‚îÄ‚îÄ LOADING ‚îÄ‚îÄ */
        .loading { text-align: center; padding: 40px; color: var(--text2); }
        .spinner {
            width: 40px; height: 40px; border: 3px solid var(--card);
            border-top-color: var(--accent); border-radius: 50%;
            animation: spin 1s linear infinite; margin: 0 auto 12px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ‚îÄ‚îÄ BOTTOM NAV ‚îÄ‚îÄ */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(15,25,35,.95); backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            display: flex; justify-content: center; gap: 40px;
            padding: 12px 20px; padding-bottom: max(12px, env(safe-area-inset-bottom));
            border-top: 1px solid rgba(255,255,255,.06);
            z-index: 100;
        }
        .bottom-nav button {
            background: none; border: none; color: var(--text2);
            font-size: 11px; cursor: pointer; display: flex;
            flex-direction: column; align-items: center; gap: 4px;
            transition: color .2s;
        }
        .bottom-nav button.active { color: var(--accent); }
        .bottom-nav button .icon { font-size: 22px; }
    </style>
</head>
<body>
<div class="app">
    <nav>
        <button class="nav-back" id="navBack" onclick="goBack()">‚Üê Back</button>
        <div class="logo">‚õ≥ <span>Personal Caddie</span></div>
        <div style="width:60px"></div>
    </nav>

    <!-- SCREEN: HOME / FEATURED COURSES -->
    <div class="screen active" id="screenHome">
        <div class="search-wrap">
            <span class="search-icon">üîç</span>
            <input class="search-box" id="courseSearch" placeholder="Search courses..." autocomplete="off">
        </div>
        <div class="section-title">Featured Courses</div>
        <div class="course-grid" id="courseGrid">
            <div class="loading"><div class="spinner"></div>Loading courses...</div>
        </div>
    </div>

    <!-- SCREEN: COURSE DETAIL -->
    <div class="screen" id="screenCourse">
        <div class="course-header" id="courseHeader"></div>
        <div class="section-title">Select a Hole</div>
        <div class="holes-grid" id="holesGrid"></div>
        <div id="holeDetail"></div>
    </div>

    <!-- SCREEN: SHOT ADVISOR -->
    <div class="screen" id="screenShot">
        <div id="shotHoleViz"></div>
        <div class="shot-form">
            <h3>üéØ Shot Advisor</h3>
            <div class="form-row">
                <div class="form-group">
                    <label>Distance (yds)</label>
                    <input type="number" id="fDistance" value="150" min="1">
                </div>
                <div class="form-group">
                    <label>Lie</label>
                    <select id="fLie">
                        <option value="tee">Tee</option>
                        <option value="fairway" selected>Fairway</option>
                        <option value="rough">Rough</option>
                        <option value="sand">Bunker</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label>Wind Speed (mph)</label>
                <input type="range" id="fWind" min="0" max="35" value="0" style="width:100%;accent-color:var(--accent)" oninput="document.getElementById('windVal').textContent=this.value+' mph'">
                <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--text2);margin-top:4px"><span>Calm</span><span id="windVal">0 mph</span><span>35+</span></div>
            </div>
            <div class="form-group" style="margin-top:8px">
                <label>Wind Direction (relative to shot)</label>
                <div class="wind-compass">
                    <div class="wind-btn active" data-wind="calm" onclick="setWind(this)">üçÉ<br>Calm</div>
                    <div class="wind-btn" data-wind="headwind" onclick="setWind(this)">‚¨áÔ∏è<br>Into</div>
                    <div class="wind-btn" data-wind="tailwind" onclick="setWind(this)">‚¨ÜÔ∏è<br>Helping</div>
                    <div class="wind-btn" data-wind="left-to-right" onclick="setWind(this)">‚û°Ô∏è<br>L‚ÜíR</div>
                    <div class="wind-btn" data-wind="right-to-left" onclick="setWind(this)">‚¨ÖÔ∏è<br>R‚ÜíL</div>
                </div>
                <input type="hidden" id="fWindDir" value="calm">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Elevation Œî (ft)</label>
                    <input type="number" id="fElev" value="0" step="5">
                </div>
                <div class="form-group" style="display:flex;align-items:flex-end;">
                    <button class="btn-recommend" id="btnRecommend" onclick="getRecommendation()">
                        Get Club
                    </button>
                </div>
            </div>
        </div>
        <div id="recResult"></div>
    </div>

    <div class="bottom-nav">
        <button class="active" onclick="showScreen('home')"><span class="icon">üè†</span>Courses</button>
        <button onclick="showScreen('shot')"><span class="icon">üéØ</span>Advisor</button>
    </div>
</div>

<script>
const API = window.location.origin;
let allCourses = [];
let currentCourse = null;
let currentHoles = [];
let selectedHole = null;
let navStack = ['home'];

// ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ
function showScreen(name) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById('screen' + name.charAt(0).toUpperCase() + name.slice(1)).classList.add('active');
    document.querySelectorAll('.bottom-nav button').forEach(b => b.classList.remove('active'));
    if (name === 'home') document.querySelectorAll('.bottom-nav button')[0].classList.add('active');
    if (name === 'shot') document.querySelectorAll('.bottom-nav button')[1].classList.add('active');
    document.getElementById('navBack').style.display = (name === 'home') ? 'none' : 'block';
    if (name !== navStack[navStack.length - 1]) navStack.push(name);
}

function goBack() {
    navStack.pop();
    const prev = navStack[navStack.length - 1] || 'home';
    showScreen(prev);
}

// ‚îÄ‚îÄ LOAD COURSES ‚îÄ‚îÄ
async function loadCourses() {
    try {
        const res = await fetch(`${API}/api/v1/courses`);
        const data = await res.json();
        allCourses = data.courses || [];
        renderCourseGrid(allCourses);
    } catch (e) {
        document.getElementById('courseGrid').innerHTML = '<div class="error-msg">Could not load courses</div>';
    }
}

function renderCourseGrid(courses) {
    const grid = document.getElementById('courseGrid');
    if (!courses.length) { grid.innerHTML = '<div style="color:var(--text2);text-align:center;padding:20px">No courses found</div>'; return; }

    const featured = ['augusta_national', 'tpc_sawgrass', 'st_andrews_old', 'pebble_beach', 'pine_valley'];
    const local = ['rocky_river', 'eagle_chase', 'sunset_hills', 'warrior_gc', 'skybrook'];
    
    // Sort: local first, then featured, then rest
    const sorted = [...courses].sort((a, b) => {
        const aLocal = local.includes(a.id) ? 0 : 1;
        const bLocal = local.includes(b.id) ? 0 : 1;
        if (aLocal !== bLocal) return aLocal - bLocal;
        const aFeat = featured.includes(a.id) ? 0 : 1;
        const bFeat = featured.includes(b.id) ? 0 : 1;
        return aFeat - bFeat;
    });

    grid.innerHTML = sorted.map(c => {
        const isFeatured = featured.includes(c.id);
        const isLocal = local.includes(c.id);
        let badge = '';
        if (isLocal) badge = '<span class="course-card-badge" style="background:rgba(79,195,247,.15);color:#4fc3f7">üìç Charlotte Area</span>';
        else if (isFeatured) badge = '<span class="course-card-badge featured-badge">‚≠ê Featured</span>';
        return `<div class="course-card" onclick="openCourse('${c.id}')">
            ${badge}
            <div class="course-card-name">${c.name}</div>
            <div class="course-card-meta">
                <span>‚õ≥ ${c.holes} holes</span>
                <span>üìç ${c.elevation_feet} ft</span>
            </div>
        </div>`;
    }).join('');
}

// ‚îÄ‚îÄ SEARCH ‚îÄ‚îÄ
document.getElementById('courseSearch').addEventListener('input', (e) => {
    const q = e.target.value.trim().toLowerCase();
    if (!q) { renderCourseGrid(allCourses); return; }
    renderCourseGrid(allCourses.filter(c => c.name.toLowerCase().includes(q)));
});

// ‚îÄ‚îÄ COURSE DETAIL ‚îÄ‚îÄ
async function openCourse(courseId) {
    showScreen('course');
    currentCourse = allCourses.find(c => c.id === courseId);

    document.getElementById('courseHeader').innerHTML = `
        <h2>${currentCourse.name}</h2>
        <div class="course-header-stats">
            <span>‚õ≥ ${currentCourse.holes} holes</span>
            <span>üìç ${currentCourse.elevation_feet} ft elevation</span>
        </div>
    `;

    // Load holes
    try {
        const res = await fetch(`${API}/api/v1/courses/${courseId}/holes`);
        const data = await res.json();
        currentHoles = data.holes || [];
        renderHoleChips();
        if (currentHoles.length > 0) selectHole(currentHoles[0]);
    } catch (e) {
        document.getElementById('holesGrid').innerHTML = '<div class="error-msg">Could not load holes</div>';
    }
}

function renderHoleChips() {
    document.getElementById('holesGrid').innerHTML = currentHoles.map(h => {
        const parClass = h.par === 3 ? 'par3' : h.par === 5 ? 'par5' : 'par4';
        return `<div class="hole-chip" id="chip${h.hole_number}" onclick="selectHole(currentHoles.find(x=>x.hole_number===${h.hole_number}))">
            ${h.hole_number}
            <div class="par-dot ${parClass}-dot"></div>
        </div>`;
    }).join('');
}

function selectHole(hole) {
    selectedHole = hole;
    document.querySelectorAll('.hole-chip').forEach(c => c.classList.remove('active'));
    const chip = document.getElementById('chip' + hole.hole_number);
    if (chip) chip.classList.add('active');
    renderHoleDetail(hole);
}

function renderHoleDetail(hole) {
    const parClass = hole.par === 3 ? 'par3' : hole.par === 5 ? 'par5' : 'par4';
    const parBadge = `badge-${parClass}`;
    const hazardChips = (hole.hazards || []).map(h => {
        const cls = h.type === 'water' ? 'hazard-water' : h.type === 'bunker' ? 'hazard-bunker' : h.type === 'out_of_bounds' ? 'hazard-ob' : 'hazard-trees';
        const icon = h.type === 'water' ? 'üíß' : h.type === 'bunker' ? '‚è≥' : h.type === 'out_of_bounds' ? 'üö´' : 'üå≤';
        return `<span class="hazard-chip ${cls}">${icon} ${h.description || h.type} (${h.location})</span>`;
    }).join('');

    document.getElementById('holeDetail').innerHTML = `
        <div class="hole-viz">
            <div class="hole-viz-header">
                <h3>Hole ${hole.hole_number}</h3>
                <div class="hole-viz-badges">
                    <span class="badge ${parBadge}">Par ${hole.par}</span>
                    <span class="badge" style="background:rgba(255,255,255,.06);color:var(--text2)">${hole.distance} yds</span>
                </div>
            </div>
            <div class="hole-svg-container" onclick="handleHoleTap(event, ${hole.hole_number})" id="holeVizSvg">${generateHoleSVG(hole)}</div>
            <div class="tap-hint">üëÜ Tap the hole to set your position and get distance to pin</div>
            <div class="hole-info-row"><span class="hole-info-label">Distance</span><span class="hole-info-value">${hole.distance} yards</span></div>
            <div class="hole-info-row"><span class="hole-info-label">Par</span><span class="hole-info-value">${hole.par}</span></div>
            <div class="hole-info-row"><span class="hole-info-label">Handicap</span><span class="hole-info-value">${hole.handicap_index}</span></div>
            <div class="hole-info-row"><span class="hole-info-label">Elevation</span><span class="hole-info-value">${hole.elevation_change > 0 ? '+' : ''}${hole.elevation_change} ft</span></div>
            <div class="hole-info-row"><span class="hole-info-label">Green</span><span class="hole-info-value">${(hole.green_shape || 'medium').replace('_',' ')}</span></div>
            ${hazardChips ? `<div class="hazard-list">${hazardChips}</div>` : ''}
            ${hole.notes ? `<div style="margin-top:12px;font-size:13px;color:var(--text2);font-style:italic">üìù ${hole.notes}</div>` : ''}
        </div>
        <button class="btn-recommend" onclick="startShot()" style="margin-top:0">üéØ Get Club Recommendation</button>
    `;
}

// ‚îÄ‚îÄ WIND SELECTOR ‚îÄ‚îÄ
function setWind(el) {
    document.querySelectorAll('.wind-btn').forEach(b => b.classList.remove('active'));
    el.classList.add('active');
    document.getElementById('fWindDir').value = el.dataset.wind;
}

// ‚îÄ‚îÄ HOLE SVG VISUALIZATION ‚îÄ‚îÄ
function generateHoleSVG(hole, interactive) {
    const w = 300, h = 540;
    const isPar3 = hole.par === 3;
    const isPar5 = hole.par === 5;

    // Fairway dimensions based on par
    const fwTop = isPar3 ? 180 : 100;
    const fwBottom = h - 100;
    const fwWidth = isPar3 ? 60 : isPar5 ? 80 : 70;
    const greenY = fwTop - 10;
    const greenRx = isPar3 ? 30 : 35;
    const greenRy = isPar3 ? 22 : 25;
    const teeY = fwBottom + 30;

    let hazardsSVG = '';
    (hole.hazards || []).forEach(hz => {
        const hzColor = hz.type === 'water' ? '#4fc3f7' : hz.type === 'bunker' ? '#ffcc02' : hz.type === 'out_of_bounds' ? '#ff4757' : '#2d8a4e';
        const hzOpacity = hz.type === 'water' ? 0.4 : hz.type === 'bunker' ? 0.5 : 0.3;
        let hzX = w / 2, hzY = fwBottom - ((hz.distance / hole.distance) * (fwBottom - fwTop));
        if (hz.distance === 0) hzY = greenY;

        if (hz.location === 'left') hzX = w / 2 - fwWidth - 15;
        else if (hz.location === 'right') hzX = w / 2 + fwWidth + 15;
        else if (hz.location === 'short') { hzX = w / 2; hzY = greenY + 30; }
        else if (hz.location === 'long') { hzX = w / 2; hzY = greenY - 30; }
        else hzX = w / 2;

        if (hz.type === 'water') {
            hazardsSVG += `<ellipse cx="${hzX}" cy="${hzY}" rx="25" ry="15" fill="${hzColor}" opacity="${hzOpacity}"/>`;
            hazardsSVG += `<text x="${hzX}" y="${hzY + 4}" text-anchor="middle" font-size="10" fill="${hzColor}">üíß</text>`;
        } else if (hz.type === 'bunker') {
            hazardsSVG += `<ellipse cx="${hzX}" cy="${hzY}" rx="18" ry="10" fill="${hzColor}" opacity="${hzOpacity}"/>`;
        } else if (hz.type === 'out_of_bounds') {
            const x1 = hz.location === 'left' ? 10 : w - 10;
            hazardsSVG += `<line x1="${x1}" y1="${fwTop}" x2="${x1}" y2="${fwBottom}" stroke="${hzColor}" stroke-width="3" stroke-dasharray="8,4" opacity="0.6"/>`;
            hazardsSVG += `<text x="${x1}" y="${(fwTop+fwBottom)/2}" text-anchor="middle" font-size="9" fill="${hzColor}" transform="rotate(-90,${x1},${(fwTop+fwBottom)/2})">OB</text>`;
        } else {
            hazardsSVG += `<rect x="${hzX-15}" y="${hzY-15}" width="30" height="30" rx="8" fill="${hzColor}" opacity="${hzOpacity}"/>`;
            hazardsSVG += `<text x="${hzX}" y="${hzY + 4}" text-anchor="middle" font-size="10" fill="${hzColor}">üå≤</text>`;
        }
    });

    // Distance reference lines from pin (100, 150, 200, 250)
    const distLines = [100, 150, 200];
    if (hole.distance > 350) distLines.push(250);
    if (hole.distance > 500) distLines.push(300);

    const markersSVG = distLines.filter(d => d < hole.distance - 30).map(d => {
        const y = greenY + ((d / hole.distance) * (fwBottom - fwTop));
        const color = d === 150 ? 'rgba(0,212,170,.4)' : 'rgba(255,255,255,.15)';
        const textColor = d === 150 ? 'rgba(0,212,170,.6)' : 'rgba(255,255,255,.3)';
        const sw = d === 150 ? '1.5' : '1';
        return `
            <line x1="${w/2-fwWidth+10}" y1="${y}" x2="${w/2+fwWidth-10}" y2="${y}" stroke="${color}" stroke-width="${sw}" stroke-dasharray="4,4"/>
            <text x="${w/2+fwWidth+5}" y="${y+4}" font-size="9" fill="${textColor}" font-weight="${d===150?'bold':'normal'}">${d}</text>
            <text x="${w/2-fwWidth-2}" y="${y+4}" font-size="9" fill="${textColor}" text-anchor="end">${d}</text>
        `;
    }).join('');

    return `<svg viewBox="0 0 ${w} ${h}" xmlns="http://www.w3.org/2000/svg">
        <!-- Rough -->
        <rect width="${w}" height="${h}" fill="#0a1510"/>
        <!-- Fairway -->
        <path d="M ${w/2-fwWidth} ${fwBottom}
                 Q ${w/2-fwWidth-10} ${(fwTop+fwBottom)/2} ${w/2-fwWidth+5} ${fwTop+20}
                 Q ${w/2-15} ${fwTop} ${w/2} ${fwTop}
                 Q ${w/2+15} ${fwTop} ${w/2+fwWidth-5} ${fwTop+20}
                 Q ${w/2+fwWidth+10} ${(fwTop+fwBottom)/2} ${w/2+fwWidth} ${fwBottom} Z"
              fill="#1a4d2e" stroke="#2a6b3e" stroke-width="1"/>
        <!-- Green -->
        <ellipse cx="${w/2}" cy="${greenY}" rx="${greenRx}" ry="${greenRy}" fill="#2d8a4e" stroke="#3da65e" stroke-width="1.5"/>
        <!-- Pin -->
        <line x1="${w/2}" y1="${greenY-18}" x2="${w/2}" y2="${greenY-2}" stroke="white" stroke-width="1.5"/>
        <polygon points="${w/2},${greenY-18} ${w/2+10},${greenY-13} ${w/2},${greenY-8}" fill="#ff4757"/>
        <!-- Tee box -->
        <rect x="${w/2-20}" y="${teeY-6}" width="40" height="12" rx="3" fill="#4a7c59" stroke="#5a9c6a" stroke-width="1"/>
        <!-- Distance label -->
        <text x="${w/2}" y="${teeY+22}" text-anchor="middle" font-size="12" font-weight="bold" fill="white">${hole.distance} yds</text>
        ${markersSVG}
        ${hazardsSVG}
        <!-- Hole number -->
        <text x="16" y="30" font-size="14" font-weight="bold" fill="rgba(255,255,255,.5)">#${hole.hole_number}</text>
        <text x="${w-16}" y="30" text-anchor="end" font-size="12" fill="rgba(255,255,255,.3)">Par ${hole.par}</text>
    </svg>`;
}

// ‚îÄ‚îÄ INTERACTIVE HOLE TAP ‚îÄ‚îÄ
let playerPosition = null;

function handleHoleTap(event, holeNum) {
    const container = event.currentTarget;
    const rect = container.getBoundingClientRect();
    const clickY = event.clientY - rect.top;
    const clickX = event.clientX - rect.left;
    const relY = clickY / rect.height;
    const relX = clickX / rect.width;

    const hole = selectedHole || currentHoles.find(h => h.hole_number === holeNum);
    if (!hole) return;

    // Map click position to distance from pin
    // Top of SVG = pin (greenY), bottom = tee
    // SVG layout: green ~top 20%, tee ~bottom 85%
    const greenFrac = 0.15;  // green is at ~15% from top
    const teeFrac = 0.85;    // tee is at ~85% from top

    if (relY < greenFrac || relY > teeFrac + 0.05) return; // Outside playable area

    const distFrac = (relY - greenFrac) / (teeFrac - greenFrac);
    const distToPin = Math.round(distFrac * hole.distance);
    
    // Determine lie based on X position
    const centerFrac = 0.5;
    const fwHalf = 0.15; // fairway is ~30% of width
    let lie = 'fairway';
    if (Math.abs(relX - centerFrac) > fwHalf + 0.05) lie = 'rough';
    
    playerPosition = { distToPin, lie, relX, relY };

    // Update the SVG with player marker
    const svgContainer = document.getElementById('holeVizSvg');
    if (svgContainer) {
        const svg = svgContainer.querySelector('svg');
        if (svg) {
            // Remove old marker
            const old = svg.querySelector('#playerMarker');
            if (old) old.remove();
            
            const svgW = 300, svgH = 540;
            const px = relX * svgW;
            const py = relY * svgH;
            
            const marker = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            marker.id = 'playerMarker';
            marker.innerHTML = `
                <circle cx="${px}" cy="${py}" r="8" fill="var(--accent,#00d4aa)" opacity="0.9" stroke="white" stroke-width="2"/>
                <circle cx="${px}" cy="${py}" r="3" fill="white"/>
                <rect x="${px-35}" y="${py+14}" width="70" height="22" rx="6" fill="rgba(0,0,0,.8)"/>
                <text x="${px}" y="${py+29}" text-anchor="middle" font-size="12" font-weight="bold" fill="#00d4aa">${distToPin} yds</text>
            `;
            svg.appendChild(marker);
        }
    }

    // Update the distance input in shot form
    document.getElementById('fDistance').value = distToPin;
    document.getElementById('fLie').value = lie === 'rough' ? 'rough' : 'fairway';
    
    // Show mini toast
    const hint = document.querySelector('.tap-hint');
    if (hint) {
        hint.textContent = `üìç ${distToPin} yards to pin ‚Ä¢ ${lie} ‚Ä¢ Tap "Get Club" below`;
        hint.style.opacity = '1';
        hint.style.color = 'var(--accent)';
    }
}

// ‚îÄ‚îÄ SHOT ADVISOR ‚îÄ‚îÄ
function startShot() {
    showScreen('shot');
    if (selectedHole) {
        document.getElementById('fDistance').value = selectedHole.distance;
        document.getElementById('fElev').value = selectedHole.elevation_change || 0;
        document.getElementById('shotHoleViz').innerHTML = `
            <div class="hole-viz" style="margin-bottom:16px">
                <div class="hole-viz-header">
                    <h3>${currentCourse?.name || 'Course'} ‚Äî Hole ${selectedHole.hole_number}</h3>
                    <span class="badge badge-par${selectedHole.par === 3 ? '3' : selectedHole.par === 5 ? '5' : '4'}">Par ${selectedHole.par}</span>
                </div>
                <div class="hole-svg-container" onclick="handleHoleTap(event, ${selectedHole.hole_number})" id="holeVizSvg">${generateHoleSVG(selectedHole)}</div>
                <div class="tap-hint">üëÜ Tap your position on the hole to auto-calculate distance</div>
            </div>
        `;
    }
}

async function getRecommendation() {
    const btn = document.getElementById('btnRecommend');
    const result = document.getElementById('recResult');
    btn.disabled = true;
    btn.textContent = 'Analyzing...';
    result.innerHTML = '<div class="loading"><div class="spinner"></div>Your caddie is thinking...</div>';

    const courseId = currentCourse?.id || (allCourses[0]?.id);
    const holeNum = selectedHole?.hole_number || 1;

    try {
        const res = await fetch(`${API}/api/v1/recommendation/simple`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                course_id: courseId,
                hole_number: holeNum,
                distance_to_pin: parseInt(document.getElementById('fDistance').value) || 150,
                wind_speed: parseInt(document.getElementById('fWind').value) || 0,
                wind_direction: document.getElementById('fWindDir').value,
                lie: document.getElementById('fLie').value,
                elevation_change: parseInt(document.getElementById('fElev').value) || 0,
            })
        });

        if (!res.ok) {
            let detail = `HTTP ${res.status}`;
            try { const err = await res.json(); detail = err.detail || detail; } catch(e) {}
            throw new Error(detail);
        }

        const rec = await res.json();
        result.innerHTML = `
            <div class="rec-card">
                <div class="rec-club">${rec.primary_club}</div>
                <div class="rec-call">"${rec.caddie_call}"</div>
                <div class="rec-stats">
                    <div class="rec-stat">
                        <div class="rec-stat-val">${rec.adjusted_distance}</div>
                        <div class="rec-stat-label">Yards</div>
                    </div>
                    <div class="rec-stat">
                        <div class="rec-stat-val">${rec.confidence}%</div>
                        <div class="rec-stat-label">Confidence</div>
                    </div>
                    <div class="rec-stat">
                        <div class="rec-stat-val">${rec.optimal_miss?.split(' ')[1] || '‚Äî'}</div>
                        <div class="rec-stat-label">Miss To</div>
                    </div>
                </div>
                <div class="rec-detail">
                    <h4>Why This Club</h4>
                    <p>${rec.why || ''}</p>
                </div>
                <div class="rec-detail">
                    <h4>Target</h4>
                    <p>${rec.primary_target || ''}</p>
                </div>
                ${rec.danger_zone ? `<div class="rec-detail"><h4>‚ö†Ô∏è Danger Zone</h4><p style="color:var(--danger)">${rec.danger_zone}</p></div>` : ''}
                ${rec.risk_reward ? `
                <div class="rec-risk">
                    <div class="rec-risk-item risk-agg">
                        <div class="risk-label">üî• Aggressive</div>
                        <div>‚Üë ${rec.risk_reward.aggressive_upside}</div>
                        <div>‚Üì ${rec.risk_reward.aggressive_downside}</div>
                    </div>
                    <div class="rec-risk-item risk-con">
                        <div class="risk-label">üõ°Ô∏è Conservative</div>
                        <div>‚Üë ${rec.risk_reward.conservative_upside}</div>
                        <div>‚Üì ${rec.risk_reward.conservative_downside}</div>
                    </div>
                </div>` : ''}
                ${rec.alternatives?.length ? `
                <div class="rec-alts">
                    <div class="section-title" style="margin-top:16px;margin-bottom:8px">Alternatives</div>
                    ${rec.alternatives.map(a => `
                        <div class="rec-alt">
                            <div class="rec-alt-club">${a.club}</div>
                            <div class="rec-alt-scenario">${a.scenario}</div>
                        </div>
                    `).join('')}
                </div>` : ''}
                ${rec.caddie_note ? `<div class="caddie-note">üß¢ ${rec.caddie_note}</div>` : ''}
            </div>
        `;
    } catch (e) {
        result.innerHTML = `<div class="error-msg">‚ùå ${e.message}</div>`;
    } finally {
        btn.disabled = false;
        btn.textContent = 'Get Club';
    }
}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
loadCourses();
</script>
</body>
</html>
